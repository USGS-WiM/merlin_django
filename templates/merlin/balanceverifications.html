{% extends 'merlin/base.html' %}
{% block body_block %}

    <div id="loading_overlay"></div>
    <div style="padding:10px">

        <p>
            <button type="button" class="btn btn-default" name="add">Add New Balance Verification</button>
        </p>
        <div id="form_add" class="panel-default" style="display:none;">
            <h3>Create Balance Verification</h3>
            <form class="form-inline" style="border:1px solid;width:1100px;padding:4px;">
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="balance">Balance Serial Number</label><br />
                    <input class="input-block-level" name="balance" id="balance" type="text" style="width:400px">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="analyst">Analyst</label><br />
                    <select class="input-block-level" name="analyst" id="analyst" style="height:26px;"></select>
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="verification_date">Date</label><br />
                    <input class="input-block-level" name="verification_date" id="verification_date">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="verification_time">Time</label><br />
                    <input class="input-block-level" name="verification_time" id="verification_time">
                </div>
                <br />
                <div class="form-group" style="padding:2px;width:120px;text-align:center">
                    <span><b>First Weight</b></span>
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="weight_tested1">Weight Tested</label><br />
                    <input class="input-block-level" name="weight_tested1" id="weight_tested1">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="weight_as_found1">Weight as Found</label><br />
                    <input class="input-block-level" name="weight_as_found1" id="weight_as_found1">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="deviation1">Deviation</label><br />
                    <input class="input-block-level" name="deviation1" id="deviation1">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="percent_recovery1">% Recovery</label><br />
                    <input class="input-block-level" name="percent_recovery1" id="percent_recovery1">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="final_reading1">Final Reading</label><br />
                    <input class="input-block-level" name="final_reading1" id="final_reading1">
                </div>
                <br />
                <div class="form-group" style="padding:2px;width:120px;text-align:center">
                    <span><b>Second Weight</b></span>
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="weight_tested2">Weight Tested</label><br />
                    <input class="input-block-level" name="weight_tested2" id="weight_tested2">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="weight_as_found2">Weight as Found</label><br />
                    <input class="input-block-level" name="weight_as_found2" id="weight_as_found2">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="deviation2">Deviation</label><br />
                    <input class="input-block-level" name="deviation2" id="deviation2">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="percent_recovery2">% Recovery</label><br />
                    <input class="input-block-level" name="percent_recovery2" id="percent_recovery2">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="final_reading2">Final Reading</label><br />
                    <input class="input-block-level" name="final_reading2" id="final_reading2">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="comment">Comment</label><br />
                    <input class="input-block-level" name="comment" type="text" style="width:1060px">
                </div>
            </form>
            <br />
            <button type="button" class="btn btn-primary" data-loading-text="Saving..." name="addSave">Save</button>
        </div>
        <br />
        <pre id="grid_console" class="console" style="width:600px"></pre>
        <p><input id="select_field" type="hidden" placeholder="Filter by serial number." style="width:600px"/></p>
        <p>
            <div class="select2-container select2-container-multi" style="width:600px">
                <ul class="select2-choices">
                    <li class="select2-search-field">
                        <label class="select2-offscreen"></label>
                        <input id="search_field" type="search" placeholder="Highlight in table." class="select2-input select2-default" style="width:393px;height:30px;font-size:14px;"/>
                    </li>
                </ul>
            </div>
        <!-- <p><input id="search_field" type="search" placeholder="Highlight in table." style="width:600px; border:1px solid darkgray; height:42px"/></p> -->
        <br /><br />
        <p>
            {% if request.session.is_staff %}
            <button type="button" class="btn btn-warning" data-loading-text="Saving..." name="save">Save</button>
            <button type="button" class="btn btn-danger" data-loading-text="Deleting..." name="delete">Delete Row</button>
            {% endif %}
            <button type="button" class="btn btn-default" data-loading-text="Reloading..." name="load">Reload Table</button>
            <button type="button" class="btn btn-default" data-loading-text="Getting Previous..." name="prev">Previous Page</button>
            <button type="button" class="btn btn-default" data-loading-text="Getting Next..." name="next">Next Page</button>
            <span id="page"></span>
        </p>
        <div id="grid" data-data="{{ data }}" data-balances="{{ balances }}" data-analysts="{{ analysts }}" ></div>

		<script>
            $(document).ready(function() {

				var loading_overlay = $('#loading_overlay');
				loading_overlay.hide();

                var csrftoken = $.cookie('csrftoken');
                function csrfSafeMethod(method) {
                    // these HTTP methods do not require CSRF protection
                    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                }
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });

                var validTable = false;
                var dateToday = new Date(); //toISOString().split("T")[0];
                var validateTime = function(value, callback) {
                    // convert the string to number to allow math operations; also trims off leading zeroes
                    value = Number(value);
                    switch (value.toString().length) {
                        case 2: // between 12:09am and 1:00am (00:xx)
                            // minutes must be less than 60
                            if(value < 60){callback(true);}
                            else {callback(false);}
                            break;
                        case 3: // between 1am and 10am (1:xx thru 9:xx)
                            // convert to string to extract the minutes, then convert back to number to test if less than 60 (all single digit hours (1 thru 9) are allowed and thus not tested)
                            if(Number(value.toString().substring(1,3)) < 60){callback(true);}
                            else {callback(false);}
                            break;
                        case 4: // after 10am (10:xx thru xx:xx)
                            // convert to string to separately extract hours and minutes, then convert back to number to test if less than 24 and 60, respectively
                            if(Number(value.toString().substring(0,2)) < 24 && Number(value.toString().substring(2,4)) < 60){callback(true);}
                            else {callback(false);}
                            break;
                        default: // any other cases (1 digit, 00:00 thru 00:09) are allowed; column is already limited to 4 digits in the constructor, so no need to test for cases of 5 or more digits
                            {callback(true);}
                            break;
                    }
                };
                var objectFields = ["id", "balance", "balance_string", "analyst", "analyst_string", "verification_date", "verification_time", "weight_tested", "weight_as_found", "deviation", "percent_recovery", "final_reading", "comment"];
                var currentPage = 1;
                var addClicked = false;
                var grid = $('#grid');
                var data_data = JSON.parse(grid.attr("data-data"));
                var resultPages = Math.ceil(data_data['count'] / 100);
                var grid_console = $("#grid_console");
                var changedRowIndices = [];
                var selectionRowIndices = [];
                grid_console.text('Loading data.');

                var data_balances = JSON.parse(grid.attr("data-balances"));
                var balance = $("#balance").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    data: { results: data_balances, text: 'serial_number'},
                    formatResult: formatName,
                    formatSelection: formatName
                });//.on("change", function(e) {});

                var data_analysts = JSON.parse(grid.attr("data-analysts"));
                var analyst = $("#analyst");
                analyst.append(new Option("", ""));
                for (var i in data_analysts) {
                    analyst.append(new Option(data_analysts[i].username, data_analysts[i].id));
                }

                function calculateDeviation() {
                    var d1 = $('#deviation1');
                    var deviation1 = null;
                    var weight_tested1 = $('#weight_tested1').val();
                    var weight_as_found1 = $('#weight_as_found1').val();
                    if (weight_tested1 !== null && weight_tested1 !== "" && !isNaN(weight_tested1) && weight_as_found1 !== null && weight_as_found1 !== "" && !isNaN(weight_as_found1)) {
                        deviation1 = (weight_tested1 - weight_as_found1).toFixed(5);
                    }
                    d1.val(deviation1);

                    var d2 = $('#deviation2');
                    var deviation2 = null;
                    var weight_tested2 = $('#weight_tested2').val();
                    var weight_as_found2 = $('#weight_as_found2').val();
                    if (weight_tested2 !== null && weight_tested2 !== "" && !isNaN(weight_tested2) && weight_as_found2 !== null && weight_as_found2 !== "" && !isNaN(weight_as_found2)) {
                        deviation2 = (weight_tested2 - weight_as_found2).toFixed(5);
                    }
                    d2.val(deviation2);
                }

                function calculatePercentRecovery() {
                    var pd1 = $('#percent_recovery1');
                    var percent_recovery1 = null;
                    var weight_tested1 = $('#weight_tested1').val();
                    var weight_as_found1 = $('#weight_as_found1').val();
                    if (weight_tested1 !== null && weight_tested1 !== "" && !isNaN(weight_tested1) && weight_as_found1 !== null && weight_as_found1 !== "" && !isNaN(weight_as_found1)) {
                        percent_recovery1 = Math.ceil((weight_as_found1 / weight_tested1) * 100);
                        if (percent_recovery1 >= 105 || percent_recovery1 <= 95) {
                            pd1.css("background-color", "orange");
                        }
                        else {
                            pd1.css("background-color", "white");
                        }
                    }
                    pd1.val(percent_recovery1);

                    var pd2 = $('#percent_recovery2');
                    var percent_recovery2 = null;
                    var weight_tested2 = $('#weight_tested2').val();
                    var weight_as_found2 = $('#weight_as_found2').val();
                    if (weight_tested2 !== null && weight_tested2 !== "" && !isNaN(weight_tested2) && weight_as_found2 !== null && weight_as_found2 !== "" && !isNaN(weight_as_found2)) {
                        percent_recovery2 = Math.ceil((weight_as_found2 / weight_tested2) * 100);
                        if (percent_recovery2 >= 105 || percent_recovery2 <= 95) {
                            pd2.css("background-color", "orange");
                        }
                        else {
                            pd2.css("background-color", "white");
                        }
                    }
                    pd2.val(percent_recovery2);
                }

                $('#weight_tested1, #weight_as_found1').change(calculateDeviationValues);
                $('#weight_tested2, #weight_as_found2').change(calculateDeviationValues);

                function calculateDeviationValues() {
                    calculateDeviation();
                    calculatePercentRecovery();
                }

                var validatePercentRecovery = function(value, callback) {
                    if (value >= 105 || value <= 95) {callback(false);}
                    else {callback(true);}
                };

                function formatName(data) {
                    return data.serial_number;
                }


                grid.handsontable({
                    data: data_data.results,
                    manualColumnResize: true,
                    manualRowResize: true,
                    invalidCellClassName: 'customHtInvalid',
                    search: {searchResultClass: 'customHtSearchResult'},
                    fillHandle: {
                        autoInsertRow: false
                    },
                    columns: [
                        {title: "ID", data: "id", readOnly: true, width: 1},
                        {title: "Balance Serial Number ID", data: "balance", width: 1},
                        {title: "Balance Serial Number", data: "balance_string", width: 160, type: 'autocomplete',
                            strict: true, source: function (
                                query, process) {getValuesAjax('/merlinservices/equipment/', 'serial_number',
                                query, process, ('user=' + grid.handsontable('getInstance').getDataAtCell(selectionRowIndices[0], 1)))}},
                        {title: "Analyst ID", data: "analyst", width: 1},
                        {title: "Analyst", data: "analyst_string", width: 80, type: 'autocomplete', strict: true, source: getValuesDom(data_analysts, "username")},
                        {title: "Date", data: "verification_date", width: 100, type: 'date', dateFormat: 'MM/DD/YY', datePickerConfig: {maxDate: new Date()}},
                        {title: 'Time', data: "verification_time",  width: 60, type: 'numeric', validator: validateTime},
                        {title: 'Weight Tested', data: "weight_tested", width: 120, type: 'numeric', numericFormat: {pattern: '0.00000', culture: 'en-US'}},
                        {title: 'Weight as Found', data: "weight_as_found", width: 120, type: 'numeric', numericFormat: {pattern: '0.00000', culture: 'en-US'}},
                        {title: 'Deviation', data: "deviation", width: 120, type: 'numeric', numericFormat: {pattern: '0.00000', culture: 'en-US'}},
                        {title: '% Recovery', data: "percent_recovery", width: 120, type: 'numeric', validator: validatePercentRecovery},
                        {title: 'Final Reading', data: "final_reading", width: 120, type: 'numeric', numericFormat: {pattern: '0.00000', culture: 'en-US'}},
                        {title: "Comment", data: "comment", width: 400}
                    ],
                    columnSorting: true,
                    beforeChange: function(changes, source) {
                         // "changes" is a 2D array containing information about each of the edited cells [ [row, col, oldVal, newVal], [row, col, oldVal, newVal], ... ].
                        // "source" is one of the following strings: "alter", "empty", "edit", "populateFromArray", "loadData", "autofill", "paste".

                        // get index of (first) changed row
                        var changedRow = changes[0][0];
                        // get index of (first) changed column
                        var changedCol = changes[0][1];
                        // get value of (first) changed cell
                        var changedVal = changes[0][3];

                        // remember the indices of all changed rows
                        if (typeof source !== 'undefined') {
                            // for all changed cells, get the changed rows
                            for (var i = 0; i < changes.length; i++) {
                                // get the row of this cell
                                var thisRow = changes[i][0];
                                // find index of this row in the changed rows array
                                var changedRowIndex = changedRowIndices.indexOf(thisRow);
                                // if not in the array (index == -1), add it to the array, otherwise ignore
                                if (changedRowIndex == -1) {
                                    changedRowIndices.push(thisRow);
                                }
                            }
                        }

                        // update dependent columns when a value in a parent column is changed
                        if (source == 'edit' || source == 'CopyPaste.paste') {
                            // when weight_tested or weight_as_found is changed
                            if ((changedCol == 'weight_tested' || changedCol == 'weight_as_found')) {
                                // update deviation and percent_recovery
                                var deviation = null;
                                var percent_recovery = null;
                                if (changedCol == 'weight_tested') {
                                    weight_tested = changedVal;
                                    weight_as_found = grid.handsontable('getDataAtCell', changedRow, 8);
                                }
                                else {
                                    weight_tested = grid.handsontable('getDataAtCell', changedRow, 7);
                                    weight_as_found = changedVal;
                                }

                                if ((weight_tested !== null && weight_tested !== "" && !isNaN(weight_tested)) && (weight_as_found !== null && weight_as_found !== "" && !isNaN(weight_as_found))) {
                                    deviation = (weight_tested - weight_as_found).toFixed(5);
                                    percent_recovery = Math.ceil((weight_as_found / weight_tested) * 100);
                                }
                                grid.handsontable('setDataAtCell', changedRow, 9, deviation);
                                grid.handsontable('setDataAtCell', changedRow, 10, percent_recovery);
                            }
                        }
                    },
                    // get list of selected rows
                    afterSelectionEnd: function(r, c, r2, c2) {
                        // clear the array
                        selectionRowIndices.length = 0;
                        // add the beginning and ending indices
                        selectionRowIndices[0] = r;
                        selectionRowIndices[1] = r2;
                    }
                });
                //grid.data('handsontable').sort(0);
                $('#page').html("Page " + currentPage + " of " + resultPages);
                grid_console.text('Data loaded.');

                var verification_date = new Pikaday({
                    field: $('#verification_date')[0],
                    format: 'MM/DD/YY',
                    defaultDate: new Date(),
                    setDefaultDate : true,
                    maxDate: new Date()
                });

                var form_add = $("#form_add");
                form_add.find('button[name=addSave]').click(function() {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var thisDataObject = {};
                    thisDataObject['balance'] = Number(balance.val());
                    var raw_analyst = Number(analyst.val());
                    if (raw_analyst !== 0) {
                        thisDataObject['analyst'] = raw_analyst;
                    }
                    else {grid_console.text('An analyst must be selected from the list.'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    thisDataObject['weight_tested1'] = Number(form_add.find('input[name=weight_tested1]').val());
                    thisDataObject['weight_as_found1'] = Number(form_add.find('input[name=weight_as_found1]').val());
                    thisDataObject['deviation1'] = Number(form_add.find('input[name=deviation1]').val());
                    thisDataObject['percent_recovery1'] = Number(form_add.find('input[name=percent_recovery1]').val());
                    thisDataObject['final_reading1'] = Number(form_add.find('input[name=final_reading1]').val());
                    thisDataObject['weight_tested2'] = Number(form_add.find('input[name=weight_tested2]').val());
                    thisDataObject['weight_as_found2'] = Number(form_add.find('input[name=weight_as_found2]').val());
                    thisDataObject['deviation2'] = Number(form_add.find('input[name=deviation2]').val());
                    thisDataObject['percent_recovery2'] = Number(form_add.find('input[name=percent_recovery2]').val());
                    thisDataObject['final_reading2'] = Number(form_add.find('input[name=final_reading2]').val());
                    thisDataObject['comment'] = form_add.find('input[name=comment]').val();
                    if (thisDataObject['comment'] == null) {thisDataObject['comment'] = "";}
                    var baddate = form_add.find('input[name=verification_date]').val();
                    if (dateRegEx.test(baddate)) {
                        if (makeYear(baddate)!= null && makeMonth(baddate)!= null && makeDay(baddate) != null) {
                            var gooddate_string = makeYear(baddate) + "-" + makeMonth(baddate) + "-" + makeDay(baddate);
                            var gooddate = new Date(makeYear(baddate), makeMonth(baddate)-1, makeDay(baddate));
                            if (gooddate > dateToday) {
                                {grid_console.text('Date cannot be a future date!'); button_state.button('reset'); return false;}
                            }
                            thisDataObject['verification_date'] = gooddate_string;
                        }
                        else {grid_console.text('There is a problem with the Date. Please contact the administrator.'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    }
                    else {grid_console.text('Date is badly formed. Expecting a date in mm/dd/yy format but found ' + baddate + '!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    var verification_time = form_add.find('input[name=verification_time]').val();
                    if (timeRegEx.test(verification_time)) {
                        var changedVal = verification_time.toString();
                        var newValue;
                        switch (changedVal.length) {
                            case 1:
                                newValue = "00:0" + changedVal;
                                break;
                            case 2:
                                newValue = "00:" + changedVal;
                                break;
                            case 3:
                                newValue = "0" + changedVal.substring(0, 1) + ":" + changedVal.substring(1);
                                break;
                            case 4:
                                newValue = changedVal.substring(0, 2) + ":" + changedVal.substring(2);
                                break;
                            default:
                                // user must have entered an invalid time, so set it to midnight
                                newValue = "00:00";
                                break;
                        }
                        thisDataObject['verification_time'] = newValue;
                    }
                    else {grid_console.text('Time is badly formed. Expecting a time in HHMM format but found ' + verification_time + '!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    var dataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: "{% url 'merlin:balanceverifications_create' %}",
                        data: dataJSON,
                        dataType: 'json',
                        contentType: "application/json",
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            var content_type = jqXHRequest.getResponseHeader("content-type");
                            // if the content-type is plain text, then it's a custom message from our Django view
                            if (content_type.indexOf('text') > -1) {
                                grid_console.text(data);
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            // otherwise, it's JSON from the REST Services
                            else if (jqXHRequest.status === 200) {
                                // reset the add form
                                $(":input", "#form_add").not(":button").val("");
                                grid.parent().find('button[name=add]').click();
                                grid.parent().find('button[name=load]').click();
                                // need to manually reset the following three because the previous two clicks won't do it automatically for some reason
                                form_add.find('input[name=balance]').select2('data', null);
                                $('#percent_recovery1').css("background-color", "white");
                                $('#percent_recovery2').css("background-color", "white");
                                grid_console.text(textStatus+': Data saved.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            else {
                                grid_console.text(textStatus+': Save error: '+jqXHRequest.statusText+', code: '+jqXHRequest.status+'.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + ": " + textStatus);
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                });

                $('#search_field').on('keyup', function (event) {
                    grid.handsontable('getInstance').search.query(this.value);
                    grid.handsontable('getInstance').render();
                });

                $("#select_field").select2({
                    multiple: true,
                    maximumSelectionSize: 1,
                    dropdownCss:{display:'none'},
                    //minimumResultsForSearch: -1,
                    //allowClear: true,
                    minimumInputLength: 1,
                    ajax: {
                        url: '/merlinservices/balanceverifications/',
                        dataType: 'json',
                        data: function (term, page) {
                            return {
                                serial_number: term
                            };
                        },
                        results: function (data, page) {
                            data_data = data;
                            grid.data('handsontable').loadData(data_data.results);
                            grid_console.text('Filtered data loaded.');
                            return {results: data.results};
                        }
                    },
                    /*sortResults: function(results, container, query) {
                        return results.sort(function (a, b) {
                            return a - b;
                        }); //sort by ID, numerically ascending
                    },*/
                    formatResult: formatSelect2,
                    formatSelection: formatSelect2
                });

                function formatSelect2(data) {
                    return data.serial_number;
                }

                function clearChangedRowIndices() {
                    changedRowIndices.length = 0;
                }

                grid.parent().find('button[name=load]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    $.ajax({
                        url: '/merlinservices/balanceverifications/?page='+currentPage,
                        dataType: 'json',
                        success: function (response) {
                            grid_console.text("success");
                            data_data = response;
                            grid.data('handsontable').loadData(data_data.results);
                            $('#page').html("Page " + currentPage + " of " + resultPages);
                            grid_console.text('Page '+ currentPage +' data reloaded.');
                            loading_overlay.hide();
                            button_state.button('reset');
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + ": " + textStatus + ": Couldn't retrieve page to reload.");
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                    clearChangedRowIndices();
                });

                grid.parent().find('button[name=next]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (currentPage != resultPages) {
                        $.ajax({
                            url: data_data.next,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_data = response;
                                grid.data('handsontable').loadData(data_data.results);
                                currentPage++;
                                $('#page').html("Page " + currentPage + " of " + resultPages);
                                grid_console.text('Page ' + currentPage + ' of ' + resultPages + ' loaded.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus + ": Couldn't retrieve next page.");
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    else {
                        grid_console.text("End of results, there are no pages after Page " + resultPages + ".");
                        loading_overlay.hide();
                        button_state.button('reset');
                    }
                    clearChangedRowIndices();
                });

                grid.parent().find('button[name=prev]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (currentPage != 1) {
                        $.ajax({
                            url: data_data.previous,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_data = response;
                                grid.data('handsontable').loadData(data_data.results);
                                currentPage--;
                                $('#page').html("Page " + currentPage + " of " + resultPages);
                                grid_console.text('Page ' + currentPage + ' of ' + resultPages + ' loaded.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus + ": Couldn't retrieve previous page.");
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    else {
                        grid_console.text("There are no pages before Page 1.");
                        loading_overlay.hide();
                        button_state.button('reset');
                    }
                    clearChangedRowIndices();
                });

                grid.parent().find('button[name=add]').click(function () {
                    if (addClicked) {
                        addClicked = false;
                        $("#form_add").hide();
                    }
                    else {
                        addClicked = true;
                        // set the default/expected weights for balances
                        // NOTE: this only applies to analytical balances,
                        //  not top-loading balances (which aren't in the DB yet)
                        // TODO: long-term is might be best to check the balance type rather than assume
                        form_add.find('input[name=weight_tested1]').val("0.005");
                        form_add.find('input[name=weight_tested2]').val("2.0");
                        // set the current LOCAL date and time
                        var dateLocal = new Date();
                        var timeLocal = dateLocal.getHours() + "" + dateLocal.getMinutes();
                        dateLocal = ("00" + (dateLocal.getMonth() + 1)).slice(-2) + "/" + ("00" + dateLocal.getDate()).slice(-2) + "/" + dateLocal.getFullYear().toString().substr(-2);
                        form_add.find('input[name=verification_date]').val(dateLocal);
                        form_add.find('input[name=verification_time]').val(timeLocal);
                        $("#form_add").show();
                    }
                });

                grid.parent().find('button[name=delete]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (typeof selectionRowIndices[0] == 'undefined') {grid_console.text('There are no selected rows to delete!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    var thisDataRow = grid.data('handsontable').getDataAtRow(selectionRowIndices[0]);
                    var thisDataObject = {"id": thisDataRow[0]};
                    var changedDataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: "{% url 'merlin:balanceverifications_delete' %}",
                        data: changedDataJSON,
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            var content_type = jqXHRequest.getResponseHeader("content-type");
                            if (jqXHRequest.status === 200) {
                                grid.parent().find('button[name=load]').click();
                                grid_console.text('Data deleted.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            else {
                                grid.parent().find('button[name=load]').click();
                                grid_console.text(textStatus + ': Delete error: ' + jqXHRequest.statusText + ', code: ' + jqXHRequest.status + '.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + ": " + textStatus);
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                    // clear list of selected rows
                    selectionRowIndices.length = 0;
                });

                grid.parent().find('button[name=save]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var changedDataArray = [];
                    // if there are no changed rows, notify the user and stop the submission
                    if (typeof changedRowIndices == 'undefined' || changedRowIndices.length < 1) {grid_console.text('There are no changed rows to save!!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                    // otherwise loop through all changed rows
                    $.each(changedRowIndices, function(index, value) {
                        var thisDataRow = grid.data('handsontable').getDataAtRow(value);
                        var thisDataObject = {};
                        for (var i = 0; i < thisDataRow.length; i++) {
                            if (objectFields[i] == "weight_tested") {thisDataObject[objectFields[i]] = Number(thisDataRow[i]);}
                            if (objectFields[i] == "weight_as_found") {thisDataObject[objectFields[i]] = Number(thisDataRow[i]);}
                            if (objectFields[i] == "deviation") {thisDataObject[objectFields[i]] = Number(thisDataRow[i]);}
                            if (objectFields[i] == "percent_recovery") {thisDataObject[objectFields[i]] = Number(thisDataRow[i]);}
                            if (objectFields[i] == "final_reading") {thisDataObject[objectFields[i]] = Number(thisDataRow[i]);}
                            else if (objectFields[i] == 'verification_date') {
                                var baddate = thisDataRow[i];
                                if (dateRegEx.test(baddate)) {
                                    if (makeYear(baddate)!= null && makeMonth(baddate)!= null && makeDay(baddate) != null) {
                                        var gooddate_string = makeYear(baddate) + "-" + makeMonth(baddate) + "-" + makeDay(baddate);
                                        var gooddate = new Date(makeYear(baddate), makeMonth(baddate)-1, makeDay(baddate));
                                        if (gooddate > dateToday) {
                                            {grid_console.text('Date cannot be a future date!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        }
                                        thisDataObject[objectFields[i]] = gooddate_string;
                                    }
                                    else {grid_console.text('There is a problem with the Date in row ' + (index + 1) + '. Please contact the administrator.'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                }
                                else {grid_console.text('Date is badly formed in row ' + (index + 1) + '. Expecting a date in mm/dd/yy format but found ' + baddate + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                            }
                            else if (objectFields[i] == 'verification_time') {
                                var badtime = thisDataRow[i];
                                if (timeRegEx.test(badtime)) {
                                    var changedVal = badtime.toString();
                                    var newValue;
                                    switch (changedVal.length) {
                                        case 1:
                                            newValue = "00:0" + changedVal;
                                            break;
                                        case 2:
                                            newValue = "00:" + changedVal;
                                            break;
                                        case 3:
                                            newValue = "0" + changedVal.substring(0, 1) + ":" + changedVal.substring(1);
                                            break;
                                        case 4:
                                            newValue = changedVal.substring(0, 2) + ":" + changedVal.substring(2);
                                            break;
                                        default:
                                            // user must have entered an invalid time, so set it to midnight
                                            newValue = "00:00";
                                            break;
                                    }
                                    thisDataObject[objectFields[i]] = newValue;
                                }
                                else {grid_console.text('Time is badly formed. Expecting a time in HHMM format but found ' + badtime + '!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                            }
                            else if (objectFields[i] == "comment") {
                                if (thisDataRow[i] == null) {
                                    thisDataRow[i] = "";
                                }
                                thisDataObject[objectFields[i]] = thisDataRow[i];
                            }
                            else {thisDataObject[objectFields[i]] = thisDataRow[i];}
                        }
                        changedDataArray.push(thisDataObject);
                        // if we made it through the various validations above, then the table must be valid
                        validTable = true;
                    });
                    // if table is valid, submit the POST request, otherwise skip it (implying table is invalid)
                    if(validTable) {
                        var changedDataJSON = JSON.stringify(changedDataArray);
                        $.ajax({
                            url: "{% url 'merlin:balanceverifications_update' %}",
                            data: changedDataJSON,
                            dataType: 'json',
                            contentType: "application/json",
                            type: 'POST',
                            success: function (data, textStatus, jqXHRequest) {
                                var content_type = jqXHRequest.getResponseHeader("content-type");
                                // if the content-type is plain text, then it's a custom message from our Django view
                                if (content_type.indexOf('text') > -1) {
                                    grid_console.text(data);
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                                // otherwise, it's JSON from the REST Services
                                else if (jqXHRequest.status === 200) {
                                    grid_console.text(textStatus + ': Data saved.');
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                                else {
                                    grid_console.text(textStatus + ': Save error: ' + jqXHRequest.statusText + ', code: ' + jqXHRequest.status + '.');
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus);
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    clearChangedRowIndices();
                });

            });
        </script>

    </div>

{% endblock %}
