{% extends 'merlin/base.html' %}
{% block body_block %}

    <div id="loading_overlay"></div>
    <div style="padding:10px">
        <p>
            <button type="button" class="btn btn-default" name="bottle_prefix_add">Add New Prefix</button>
            <button type="button" class="btn btn-default" name="bottle_prefix_range_add">Add New Range of Prefixes</button>
            <button type="button" class="btn btn-default" name="bottles_add">Add New Bottles</button>
        </p>
        <div id="form_bottle_prefix_add" class="panel-default" style="display:none;">
            <h3>Create Bottle Prefix</h3>
            <form class="form-inline" style="border:1px solid;width:1000px;padding:4px;">
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="bottle_prefix">Bottle Prefix</label><br />
                    <input class="input-block-level" name="bottle_prefix" type="text" style="width:200px">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="bottle_type_prefix">Bottle Type</label><br />
                    <select class="input-block-level" name="bottle_type_prefix" id="bottle_type_prefix" style="height:26px;"></select>
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="tare_weight">Tare Weight</label><br />
                    <input class="input-block-level" name="tare_weight" type="number">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="date_bottle_prefix">Date</label><br />
                    <input class="input-block-level" name="date_bottle_prefix" id="date_bottle_prefix">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="description">Description</label><br />
                    <input class="input-block-level" name="description" type="text">
                </div>
            </form>
            <br />
            <button type="button" class="btn btn-primary" data-loading-text="Saving..." name="bottlePrefixAddSave">Save</button>
        </div>
        <div id="form_bottle_prefix_range_add" class="panel-default" style="display:none;">
            <h3>Create Range of Bottle Prefixes</h3>
            <form class="form-inline" style="border:1px solid;width:800px;padding:4px;">
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="bottle_prefix">Prefix Letters</label><br />
                    <input class="input-block-level" name="bottle_prefix" type="text">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="bottle_range_start">Number Range Start</label><br />
                    <input class="input-block-level" name="bottle_range_start" type="text">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="bottle_range_end">Number Range End</label><br />
                    <input class="input-block-level" name="bottle_range_end" type="text">
                </div>
                <br />
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="bottle_type_prefix_range">Bottle Type</label><br />
                    <select class="input-block-level" name="bottle_type_prefix_range" id="bottle_type_prefix_range" style="height:26px;"></select>
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="tare_weight">Tare Weight</label><br />
                    <input class="input-block-level" name="tare_weight" type="text">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="date_bottle_prefix_range">Date</label><br />
                    <input class="input-block-level" name="date_bottle_prefix_range" id="date_bottle_prefix_range">
                </div>
                <div class="form-group" style="padding:2px;text-align:center">
                    <label for="description">Description</label><br />
                    <input class="input-block-level" name="description" type="text">
                </div>
            </form>
            <br />
            <button type="button" class="btn btn-primary" data-loading-text="Saving..." name="rangePrefixAddSave">Save</button>
        </div>
        <div id="grid_bottles_add" data-bottle-types="{{ bottletypes }}" style="display:none" >
            <br />
            <button type="button" class="btn btn-primary" data-loading-text="Saving..." name="bottlesAddSave">Save</button>
            <button type="button" class="btn btn-default" data-loading-text="Inserting..." name="insertRange">Insert Range</button>
            <button type="button" class="btn btn-info" data-loading-text="Exporting..." name="exportCSV">Export CSV</button>
            <button type="button" class="btn btn-default" data-loading-text="Inserting..." name="insertRows">Insert 8 Blank Rows</button>
            <button type="button" class="btn btn-danger" data-loading-text="Deleting..." name="deleteRows">Delete Rows</button>
        </div>
        <div id="bottle_range_add" style="display:none" >
            <br />
            <p>Enter the last number sequence of the bottle range: </p>
            <input id="grid_bottle_range_end" style="width:80px">
            <button type="button" class="btn btn-primary" data-loading-text="Inserting..." name="insertRangeOK">OK</button>
        </div>
        <pre id="csv" style="display:none"></pre>
        <br />

        <pre id="grid_console" class="console" style="width:600px"></pre>
        <div class="row">
            <div id="tools_prefixes" class="col-md-6">
                <p><input id="select_field_prefixes" type="hidden" placeholder="Filter by bottle prefix." style="width:600px"/></p>
                <p>
                    <div class="select2-container select2-container-multi" style="width:600px">
                        <ul class="select2-choices">
                            <li class="select2-search-field">
                                <label class="select2-offscreen"></label>
                                <input id="search_field_prefixes" type="search" placeholder="Highlight in table." class="select2-input select2-default" style="width:393px;height:30px;font-size:14px;"/>
                            </li>
                        </ul>
                    </div>
                <!-- <p><input id="search_field" type="search" placeholder="Highlight in table." style="width:600px; border:1px solid darkgray; height:42px"/></p> -->
                <br /><br />
                <p>
                    {% if request.session.is_staff %}
                    <button type="button" class="btn btn-warning" data-loading-text="Saving..." name="save">Save</button>
                    <button type="button" class="btn btn-danger" data-loading-text="Deleting..." name="delete">Delete Row</button>
                    {% endif %}
                    <button type="button" class="btn btn-default" data-loading-text="Reloading..." name="load">Reload Table</button>
                    <button type="button" class="btn btn-default" data-loading-text="Getting Previous..." name="prev">Previous Page</button>
                    <button type="button" class="btn btn-default" data-loading-text="Getting Next..." name="next">Next Page</button>
                    <span id="page_prefixes"></span>
                </p>
                <h1>Prefixes</h1>
            </div>
            <div id="tools_bottles" class="col-md-6">
                <p><input id="select_field_bottles" type="hidden" placeholder="Filter by bottle name." style="width:600px"/></p>
                <p>
                    <div class="select2-container select2-container-multi" style="width:600px">
                        <ul class="select2-choices">
                            <li class="select2-search-field">
                                <label class="select2-offscreen"></label>
                                <input id="search_field_bottles" type="search" placeholder="Highlight in table." class="select2-input select2-default" style="width:393px;height:30px;font-size:14px;"/>
                            </li>
                        </ul>
                    </div>
                <!-- <p><input id="search_field" type="search" placeholder="Highlight in table." style="width:600px; border:1px solid darkgray; height:42px"/></p> -->
                <br /><br />
                <p>
                    {% if request.session.is_staff %}
                    <button type="button" class="btn btn-warning" data-loading-text="Saving..." name="save">Save</button>
                    <button type="button" class="btn btn-danger" data-loading-text="Deleting..." name="delete">Delete Row</button>
                    {% endif %}
                    <button type="button" class="btn btn-default" data-loading-text="Reloading..." name="load">Reload Table</button>
                    <button type="button" class="btn btn-default" data-loading-text="Getting Previous..." name="prev">Previous Page</button>
                    <button type="button" class="btn btn-default" data-loading-text="Getting Next..." name="next">Next Page</button>
                    <span id="page_bottles"></span>
                </p>
                <h1>Bottles</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6" id="grid_prefixes" data-prefixes="{{ prefixes }}"></div>
            <div class="col-md-6" id="grid_bottles" data-bottles="{{ bottles }}"></div>
        </div>

		<script>
            $(document).ready(function() {

				var loading_overlay = $('#loading_overlay');
				loading_overlay.hide();

                var csrftoken = $.cookie('csrftoken');
                function csrfSafeMethod(method) {
                    // these HTTP methods do not require CSRF protection
                    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                }
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });

                var bottleAddClicked = false;
                var rangeAddClicked = false;
                var bottlesAddClicked = false;
                var grid_console = $("#grid_console");
                var bottleRangeAddClicked = false;

                var validTableAdd = false;
                var objectFieldsAdd = ["bottle_prefix", "suffix", "bottle_unique_name", "created_date", "description"];
                var grid_bottles_add = $('#grid_bottles_add');
                var data_bottle_types = JSON.parse(grid_bottles_add.attr("data-bottle-types"));
                var changedRowIndicesBottlesAdd = [];
                var dateToday = new Date(); //toISOString().split("T")[0];
                var yearToday = dateToday.getFullYear().toString();
                var monthToday = (dateToday.getMonth() + 1).toString();
                var dayToday = dateToday.getDate().toString();
                var dateTodayString = (monthToday.length < 2 ? ("0" + monthToday) : monthToday) + "/" + (dayToday.length < 2 ? ("0" + dayToday) : dayToday) + "/" + yearToday.substr(2,2);
                var grid_bottles_add_options = {
                    contextMenu: false,
                    startRows: 8,
                    manualColumnResize: true,
                    manualRowResize: true,
                    invalidCellClassName: 'customHtInvalid',
                    search: {searchResultClass: 'customHtSearchResult'},
                    fillHandle: {
                        autoInsertRow: false
                    },
                    columns: [
                        {title: "Bottle Prefix", type: 'autocomplete', strict: true, source: function (query, process) {getValuesAjax('/mercuryservices/bottleprefixes/', 'bottle_prefix', query, process)}, width: 100},
                        {title: "Suffix", width: 60},
                        {title: "Bottle Unique Name", type: 'text', width: 160},
                        {title: "Date", type: 'date', dateFormat: 'MM/DD/YY', datePickerConfig: {maxDate: new Date()}, width: 100},
                        //{title: "Tare Weight", type: 'numeric', format: '0.00', width: 100},
                        //{title: "Bottle Type", type: 'autocomplete', strict: true, source: getValuesDom(data_bottle_types,"bottle_type"), width: 240},
                        {title: "Description", type: 'text', width: 240}
                    ],
                    /*beforeAutofill: function(start, end, data) {
                        var newVal;
                        for (var i = start['row']; i <= end['row']; i++) {
                            if (start['col'] == 0) {
                                var suffix = grid_bottles_add.handsontable('getDataAtCell', i, 1);
                                newVal = data[0] + (suffix != null ? suffix : "");
                            }
                            if (start['col'] == 1) {
                                var prefix = grid_bottles_add.handsontable('getDataAtCell', i, 0);
                                newVal = (prefix != null ? prefix : "") + data[0];
                            }
                            grid_bottles_add.handsontable('setDataAtCell', i, 2, newVal);
                            grid_bottles_add.handsontable('setDataAtCell', i, 3, dateTodayString);
                        }
                    },*/
                    beforeChange: function(changes, source) {
                        // get index of changed row
                        var changedRow = changes[0][0];
                        // get index of changed column
                        var changedCol = changes[0][1];
                        // get value of changed cell
                        var changedVal = changes[0][3];

                        // remember the indices of all changed rows
                        if (source != 'loadData') {
                            // for all changed cells, get the changed rows
                            for (var i = 0; i < changes.length; i++) {
                                // get the row of this cell
                                var thisRow = changes[i][0];
                                // find index of this row in the changed rows array
                                var changedRowIndex = changedRowIndicesBottlesAdd.indexOf(thisRow);
                                // if not in the array (index == -1), add it to the array, otherwise ignore
                                if (changedRowIndex == -1) {
                                    changedRowIndicesBottlesAdd.push(thisRow);
                                }
                            }
                        }

                        // if change is Bottle Prefix or Suffix, concatenate them into the Bottle Code
                        if (changedCol == 0 || changedCol == 1) {
                            var newVal;
                            if (source == 'edit' || source == 'CopyPaste.paste') {
                                if (changedCol == 0) {
                                    var suffix;
                                    if (grid_bottles_add.handsontable('getDataAtCell', changedRow, 1) !== null) {
                                        suffix = grid_bottles_add.handsontable('getDataAtCell', changedRow, 1);
                                    }
                                    else if (grid_bottles_add.handsontable('getDataAtCell', 0, 1) !== null) {
                                        suffix = grid_bottles_add.handsontable('getDataAtCell', 0, 1);
                                        grid_bottles_add.handsontable('setDataAtCell', changedRow, 1, suffix);
                                    }
                                    newVal = changedVal + (suffix != null ? suffix : "");
                                }
                                if (changedCol == 1) {
                                    var prefix = grid_bottles_add.handsontable('getDataAtCell', changedRow, 0);
                                    newVal = (prefix != null ? prefix : "") + changedVal;
                                }
                                grid_bottles_add.handsontable('setDataAtCell', changedRow, 2, newVal);
                                if (changedRow != 0) {
                                    var datePrevRow = grid_bottles_add.handsontable('getDataAtCell', changedRow - 1, 3);
                                    if (datePrevRow !== null) {
                                        grid_bottles_add.handsontable('setDataAtCell', changedRow, 3, datePrevRow);
                                    }
                                    else {grid_bottles_add.handsontable('setDataAtCell', changedRow, 3, dateTodayString);}
                                }
                                else {grid_bottles_add.handsontable('setDataAtCell', changedRow, 3, dateTodayString);}
                            }
                            /*if (source == 'Autofill.fill') {
                                var newVal = "1";
                                // get range of autofilled rows
                                var selectedRows = grid_bottles_add.handsontable('getInstance').getSelectedRange();
                                var firstSelectedRow = selectedRows['from']['row'];
                                var lastSelectedRow = selectedRows['to']['row'];
                                // for each row in the autofill selection
                                for (var i = firstSelectedRow; i <= lastSelectedRow; i++) {
                                    if (changedCol == 0) {
                                        var suffix = grid_bottles_add.handsontable('getDataAtCell', i, 1);
                                        newVal = changedVal + (suffix != null ? suffix : "");
                                    }
                                    if (changedCol == 1) {
                                        var prefix = grid_bottles_add.handsontable('getDataAtCell', i, 0);
                                        newVal = (prefix != null ? prefix : "") + changedVal;
                                    }
                                    grid_bottles_add.handsontable('setDataAtCell', i, 2, newVal);
                                    grid_bottles_add.handsontable('setDataAtCell', i, 3, dateTodayString);
                                }
                            }*/
                        }
                    }
                };

                grid_bottles_add.handsontable(grid_bottles_add_options);

                grid_bottles_add.parent().find('button[name=insertRange]').click(function () {
                    if (bottleRangeAddClicked) {
                        bottleRangeAddClicked = false;
                        $("#bottle_range_add").hide();
                    }
                    else {
                        bottleRangeAddClicked = true;
                        $("#bottle_range_add").show();
                    }
                });

                grid_bottles_add.parent().find('button[name=insertRangeOK]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var initialDataRow = grid_bottles_add.data('handsontable').getDataAtRow(0);
                    if (!initialDataRow[0]) {grid_console.text('Prefix is required in the first row!');  loading_overlay.hide(); button_state.button('reset'); return false;}
                    var prefix = initialDataRow[0].substring(0,3);
                    var start = initialDataRow[0].substring(3);
                    var endVal = $('#grid_bottle_range_end').val();
                    //if (!endVal || !($.isNumeric(endVal)) || !(Math.floor(endVal) == endVal)) {grid_console.text('Last number sequence is required (and must be an integer)!'); return false;}
                    var end = Number(endVal);
                    if (end < Number(start)+1) {grid_console.text('Last number in sequence cannot be less than the start number!');  loading_overlay.hide(); button_state.button('reset'); return false;}
                    var digits = start.length;
                    if (!initialDataRow[1]) {grid_console.text('Suffix is required in the first row!');  loading_overlay.hide(); button_state.button('reset'); return false;}
                    var suffix = initialDataRow[1];
                    var date = initialDataRow[3];
                    var description = initialDataRow[4];
                    var new_bottles = [];
                    for (var i = (Number(start)+1); i <= end; i++) {
                        var this_prefix = prefix + (pad(i, digits, '0').toString());
                        var this_bottle_code = this_prefix + suffix;
                        var thisDataArray = [this_prefix, suffix, this_bottle_code, date, description];
                        new_bottles.push(thisDataArray)
                    }
                    //grid_bottles_add.data('handsontable').alter('insert_row', null, (end-1));
                    grid_bottles_add.data('handsontable').populateFromArray(1, 0, new_bottles); //, (end-1), 3, 'populateFromArray', 'shift_down');
                    grid_bottles_add.parent().find('button[name=insertRange]').click();
                    grid_console.text('Inserted Range.');
                    loading_overlay.hide();
                    button_state.button('reset');
                });

                grid_bottles_add.parent().find('button[name=exportCSV]').click(function() {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    /*$('#csv').show();
                    var tableData = grid_bottles_add.handsontable('getData');
                    var csv = convert2dArrayToCsv(tableData);
                    console.log(csv);
                    $('#csv').text(csv);*/
                    var table = grid_bottles_add.handsontable('getInstance');
                    var csv_filename = "bottle_codes_" + yearToday + "-" + (monthToday.length == 1 ? "0" + monthToday : monthToday) + "-" + (dayToday.length == 1 ? "0" + dayToday : dayToday) + ".csv";
                    handsontable2csv.download(table, csv_filename);
                    loading_overlay.hide();
                    button_state.button('reset');
                });

                grid_bottles_add.parent().find('button[name=insertRows]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    grid_bottles_add.data('handsontable').alter('insert_row', null, 8);
                    grid_console.text('Inserted Rows.');
                    loading_overlay.hide();
                    button_state.button('reset');
                });

                grid_bottles_add.parent().find('button[name=deleteRows]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var selectedRows = grid_bottles_add.handsontable('getInstance').getSelectedRange();
                    if (typeof selectedRows == 'undefined') {grid_console.text('There are no selected rows to delete!');  loading_overlay.hide(); button_state.button('reset'); return false;}
                    var firstSelectedRow = selectedRows['from']['row'];
                    var lastSelectedRow = selectedRows['to']['row'];
                    grid_bottles_add.data('handsontable').alter('remove_row', firstSelectedRow, (lastSelectedRow != firstSelectedRow ? (lastSelectedRow - firstSelectedRow) + 1 : 1));
                    // clear list of selected rows
                    selectedRows.length = 0;
                    loading_overlay.hide();
                    button_state.button('reset');
                });

                grid_bottles_add.parent().find('button[name=bottlesAddSave]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var changedDataArrayBottlesAdd = [];
                    //$.each(changedRowIndicesBottlesAdd, function(index, value) {
                    //    var thisDataRow = grid_bottles_add.data('handsontable').getDataAtRow(value);
                    //    var thisDataObject = {};
                    // if there are no changed rows, notify the user and stop the submission
                    if (typeof changedRowIndicesBottlesAdd == 'undefined' || changedRowIndicesBottlesAdd.length < 1) {grid_console.text('Table is empty!'); validTableAdd = false;  loading_overlay.hide(); button_state.button('reset'); return false;}
                    // otherwise loop through all rows
                    var allRows = grid_bottles_add.handsontable('getInstance').countRows();
                    for (var row = 0; row < allRows; row++) {
                        // grab all the data for this row
                        var thisDataRow = grid_bottles_add.data('handsontable').getDataAtRow(row);
                        // check if this row still has (non-default) data; it's possible the user cleared the row after entering data, in which case we no longer want it
                        // here, we're only checking for a value in the first column (Bottle Prefix), which is a required field; if it is empty, it is safe to assume that any...
                        // ...possible data in the rest of the row doesn't need to be checked, because the row can't be saved without a valid value in the first column
                        if (thisDataRow[0] !== null && thisDataRow[0] !== "" && thisDataRow[0] !== 0 && typeof thisDataRow[0] !== 'undefined') {
                            // an object container for the data in this row
                            var thisDataObject = {};
                            for (var i = 0; i < thisDataRow.length; i++) {
                                switch (i) {
                                    case 0: // prefix
                                        var thisID = updateValueAjax('/mercuryservices/bottleprefixes/', 'bottle_prefix_exact', 'id', thisDataRow[i]);
                                        if (thisID == "" || thisID === null || typeof thisID === 'undefined') {
                                            grid_console.text('Bottle Prefix must be a valid choice in row ' + (row + 1) + '!');
                                            validTableAdd = false;
                                            button_state.button('reset');
                                            return false;
                                        }
                                        thisDataObject[objectFieldsAdd[i]] = thisID;
                                        break;
                                    case 1: // suffix
                                        break;
                                    case 2: // bottle unique name
                                        thisDataObject[objectFieldsAdd[i]] = thisDataRow[i].toUpperCase();
                                        break;
                                    case 3: //date
                                        var baddate = thisDataRow[i];
                                        //var gooddate = "20" + baddate.substr(6,4) + "-" + baddate.substr(0,2) + "-" + baddate.substr(3,2);
                                        //thisDataObject[objectFields[i]] = gooddate;
                                        if (dateRegEx.test(baddate)) {
                                            if (makeYear(baddate) != null && makeMonth(baddate) != null && makeDay(baddate) != null) {
                                                var gooddate_string = makeYear(baddate) + "-" + makeMonth(baddate) + "-" + makeDay(baddate);
                                                var gooddate = new Date(makeYear(baddate), makeMonth(baddate) - 1, makeDay(baddate));
                                                if (gooddate > dateToday) {grid_console.text('Date cannot be a future date!');  loading_overlay.hide(); button_state.button('reset'); return false;}
                                                thisDataObject[objectFieldsAdd[i]] = gooddate_string;
                                            }
                                            else {grid_console.text('There is a problem with the Date in row ' + (row + 1) + '. Please contact the administrator.');  loading_overlay.hide(); button_state.button('reset'); return false;}
                                        }
                                        else {grid_console.text('Date is badly formed in row ' + (row + 1) + '. Expecting a date in mm/dd/yy format but found ' + baddate + '!');  loading_overlay.hide(); button_state.button('reset'); return false;}
                                        break;
                                    case 4: // description
                                        if (thisDataRow[i] == null) {
                                            thisDataRow[i] = "";
                                        }
                                        thisDataObject[objectFieldsAdd[i]] = thisDataRow[i];
                                        break;
                                    default:
                                        thisDataObject[objectFieldsAdd[i]] = thisDataRow[i];
                                        break;
                                }
                            }
                            // add the new row object to the array
                            changedDataArrayBottlesAdd.push(thisDataObject);
                        }
                        // if we made it through the various validations above, then the table must be valid
                        validTableAdd = true;
                    }
                    if(validTableAdd) {
                        var changedDataJSON = JSON.stringify(changedDataArrayBottlesAdd);
                        $.ajax({
                            url: "{% url 'merlin:bottles_create' %}",
                            data: changedDataJSON,
                            dataType: 'json',
                            contentType: "application/json",
                            type: 'POST',
                            success: function (data, textStatus, jqXHRequest) {
                                var content_type = jqXHRequest.getResponseHeader("content-type");
                                // if the content-type is plain text, then it's a custom message from our Django view
                                if (content_type.indexOf('text') > -1) {
                                    grid_console.text(data);
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                                // otherwise, it's JSON from the REST Services
                                else if (jqXHRequest.status === 200) {
                                    // the data was saved to the database, so empty the table
                                    //tools_bottles.find('button[name=load]').click();
                                    var rows = grid_bottles_add.handsontable('getInstance').countRows();
                                    $(":input", "#bottle_range_add").not(":button").val("");
                                    grid_bottles_add.data('handsontable').alter('remove_row', 0, rows);
                                    grid_bottles_add.data('handsontable').alter('insert_row', null, 8);
                                    grid_bottles_add.parent().find('button[name=bottles_add]').click();
                                    grid_console.text(textStatus + ': Data saved.');
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                                else {
                                    grid_console.text(textStatus + ': Save error: ' + jqXHRequest.statusText + ', code: ' + jqXHRequest.status + '.');
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus);
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    clearChangedRowIndicesBottlesAdd();
                });

                var form_bottle_prefix_add = $("#form_bottle_prefix_add");
                form_bottle_prefix_add.find('button[name=bottlePrefixAddSave]').click(function() {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var thisDataObject = {};
                    thisDataObject['bottle_prefix'] = form_bottle_prefix_add.find('input[name=bottle_prefix]').val().toUpperCase();
                    var baddate = form_bottle_prefix_add.find('input[name=date_bottle_prefix]').val();
                    //var gooddate = "20" + baddate.substr(6,4) + "-" + baddate.substr(0,2) + "-" + baddate.substr(3,2);
                    if (dateRegEx.test(baddate)) {
                        if (makeYear(baddate)!= null && makeMonth(baddate)!= null && makeDay(baddate) != null) {
                            var gooddate_string = makeYear(baddate) + "-" + makeMonth(baddate) + "-" + makeDay(baddate);
                            var gooddate = new Date(makeYear(baddate), makeMonth(baddate)-1, makeDay(baddate));
                            if (gooddate > dateToday) {
                                {grid_console.text('Date cannot be a future date!'); button_state.button('reset'); return false;}
                            }
                            thisDataObject['created_date'] = gooddate_string;
                        }
                        else {grid_console.text('There is a problem with the Date. Please contact the administrator.'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    }
                    else {grid_console.text('Date is badly formed. Expecting a date in mm/dd/yy format but found ' + baddate + '!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    thisDataObject['tare_weight'] = Number(form_bottle_prefix_add.find('input[name=tare_weight]').val());
                    thisDataObject['bottle_type'] = Number(select_bottle_type_prefix.val());
                    thisDataObject['description'] = form_bottle_prefix_add.find('input[name=description]').val();
                    if (thisDataObject['description'] == null) {thisDataObject['description'] = "";}
                    var dataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: "{% url 'merlin:bottle_prefixes_create' %}",
                        data: dataJSON,
                        dataType: 'json',
                        contentType: "application/json",
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            var content_type = jqXHRequest.getResponseHeader("content-type");
                            // if the content-type is plain text, then it's a custom message from our Django view
                            if (content_type.indexOf('text') > -1) {
                                grid_console.text(data);
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            // otherwise, it's JSON from the REST Services
                            else if (jqXHRequest.status === 200) {
                                $(":input", "#form_bottle_prefix_add").not(":button").val("");
                                form_bottle_prefix_add.parent().find('button[name=bottle_prefix_add]').click();
                                //tools_prefixes.find('button[name=load]').click();
                                grid_console.text(textStatus+': Data saved.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            else {
                                grid_console.text(textStatus+': Save error: '+jqXHRequest.statusText+', code: '+jqXHRequest.status+'.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + ": " + textStatus);
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                });

                var form_bottle_prefix_range_add = $("#form_bottle_prefix_range_add");
                form_bottle_prefix_range_add.find('button[name=rangePrefixAddSave]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var thisDataObject = {};
                    thisDataObject['prefix'] = form_bottle_prefix_range_add.find('input[name=bottle_prefix]').val().toUpperCase();
                    //thisDataObject['suffix'] = form_bottle_prefix_range_add.find('input[name=bottle_suffix]').val().toUpperCase();
                    thisDataObject['range_start'] = form_bottle_prefix_range_add.find('input[name=bottle_range_start]').val();
                    thisDataObject['range_end'] = form_bottle_prefix_range_add.find('input[name=bottle_range_end]').val();
                    var baddate = form_bottle_prefix_range_add.find('input[name=date_bottle_prefix_range]').val();
                    //var gooddate = "20" + baddate.substr(6,4) + "-" + baddate.substr(0,2) + "-" + baddate.substr(3,2);
                    if (dateRegEx.test(baddate)) {
                        if (makeYear(baddate)!= null && makeMonth(baddate)!= null && makeDay(baddate) != null) {
                            var gooddate_string = makeYear(baddate) + "-" + makeMonth(baddate) + "-" + makeDay(baddate);
                            var gooddate = new Date(makeYear(baddate), makeMonth(baddate)-1, makeDay(baddate));
                            if (gooddate > dateToday) {
                                {grid_console.text('Date cannot be a future date!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                            }
                            thisDataObject['created_date'] = gooddate_string;
                        }
                        else {grid_console.text('There is a problem with the Date. Please contact the administrator.'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    }
                    else {grid_console.text('Date is badly formed. Expecting a date in mm/dd/yy format but found ' + baddate + '!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    thisDataObject['tare_weight'] = Number(form_bottle_prefix_range_add.find('input[name=tare_weight]').val());
                    thisDataObject['bottle_type'] = Number(select_bottle_type_range.val());
                    thisDataObject['description'] = form_bottle_prefix_range_add.find('input[name=description]').val();
                    if (thisDataObject['description'] == null) {thisDataObject['description'] = "";}
                    var dataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: "{% url 'merlin:bottle_prefixes_range_create' %}",
                        data: dataJSON,
                        dataType: 'json',
                        contentType: "application/json",
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            var content_type = jqXHRequest.getResponseHeader("content-type");
                            // if the content-type is plain text, then it's a custom message from our Django view
                            if (content_type.indexOf('text') > -1) {
                                grid_console.text(data);
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            // otherwise, it's JSON from the REST Services
                            else if (jqXHRequest.status === 200) {
                                $(":input", "#form_bottle_prefix_range_add").not(":button").val("");
                                form_bottle_prefix_range_add.parent().find('button[name=bottle_prefix_range_add]').click();
                                //tools_prefixes.find('button[name=load]').click();
                                grid_console.text(textStatus+': Data saved.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            else {
                                grid_console.text(textStatus+': Save error: '+jqXHRequest.statusText+', code: '+jqXHRequest.status+'.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + ": " + textStatus);
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                });

                var date_bottle_prefix = new Pikaday({
                    field: $('#date_bottle_prefix')[0],
                    format: 'MM/DD/YY',
                    maxDate: new Date()
                });

                var date_bottle_prefix_range = new Pikaday({
                    field: $('#date_bottle_prefix_range')[0],
                    format: 'MM/DD/YY',
                    maxDate: new Date()
                });

                //$("#date_bottle_prefix").datepicker({
                //    dateFormat: "mm/dd/y",
                //    maxDate: 0
                //});

                //$("#date_bottle_prefix_range").datepicker({
                //    dateFormat: "mm/dd/y",
                //    maxDate: 0
                //});

                var select_bottle_type_prefix = $("#bottle_type_prefix");
                for (var i in data_bottle_types) {
                    select_bottle_type_prefix.append(new Option(data_bottle_types[i].bottle_type, data_bottle_types[i].id));
                }

                var select_bottle_type_range = $("#bottle_type_prefix_range");
                for (var i in data_bottle_types) {
                    select_bottle_type_range.append(new Option(data_bottle_types[i].bottle_type, data_bottle_types[i].id));
                }

                var validTablePrefix = false;
                var prefixObjectFields = ["id", "bottle_prefix", "created_date", "tare_weight", "bottle_type", "description"];
                var currentPagePrefixes = 1;
                var changedRowIndicesPrefixes = [];
                var selectionRowIndicesPrefixes = [];
                var grid_prefixes = $('#grid_prefixes');
                var data_prefixes = JSON.parse(grid_prefixes.attr("data-prefixes"));
                var resultPagesPrefixes = Math.ceil(data_prefixes['count'] / 100);
                grid_prefixes.handsontable({
                    //minSpareRows: 1,
                    data: data_prefixes.results,
                    manualColumnResize: true,
                    manualRowResize: true,
                    invalidCellClassName: 'customHtInvalid',
                    search: {searchResultClass: 'customHtSearchResult'},
                    fillHandle: {
                        autoInsertRow: false
                    },
                    columns: [
                        {title: "ID", data: "id", readOnly: true, width: 1},
                        {title: "Prefix", data: "bottle_prefix", width: 150},
                        {title: "Date", data: "created_date", width: 100, type: 'date', dateFormat: 'MM/DD/YY', datePickerConfig: {maxDate: new Date()}},
                        {title: "Tare Weight", data: "tare_weight", width: 100},
                        {title: "Bottle Type", data: "bottle_type_string", type: 'autocomplete', strict: true, source: getValuesDom(data_bottle_types,"bottle_type"), width: 120},
                        {title: "Description", data: "description", width: 220}
                    ],
                    columnSorting: true,
                    //columnSorting: { column: 0 },
                    beforeChange: function(changes, source) {
                        // "changes" is a 2D array containing information about each of the edited cells [ [row, col, oldVal, newVal], [row, col, oldVal, newVal], ... ].
                        // "source" is one of the following strings: "alter", "empty", "edit", "populateFromArray", "loadData", "Autofill.fill", "CopyPaste.paste".

                        // get index of changed row
                        var changedRow = changes[0][0];

                        // remember the indices of all changed rows
                        if (source != 'loadData') {
                            // for all changed cells, get the changed rows
                            for (var i = 0; i < changes.length; i++) {
                                // get the row of this cell
                                var thisRow = changes[i][0];
                                // find index of this row in the changed rows array
                                var changedRowIndex = changedRowIndicesPrefixes.indexOf(thisRow);
                                // if not in the array (index == -1), add it to the array, otherwise ignore
                                if (changedRowIndex == -1) {
                                    changedRowIndicesPrefixes.push(thisRow);
                                }
                            }
                        }
                        //var selectedRows = grid_bottles.handsontable('getInstance').getSelectedRange();
                        //var firstSelectedRow = selectedRows['from']['row'];
                        //var lastSelectedRow = selectedRows['to']['row'];
                        //alert(firstSelectedRow+":"+lastSelectedRow);
                    },
                    // get list of selected rows
                    afterSelectionEnd: function(r, c, r2, c2) {
                        // clear the array
                        selectionRowIndicesPrefixes.length = 0;
                        // add the beginning and ending indices
                        selectionRowIndicesPrefixes[0] = r;
                        selectionRowIndicesPrefixes[1] = r2;
                    }
                });
                //grid_prefixes.data('handsontable').sort(0);
                $('#page_prefixes').html("Page " + currentPagePrefixes + " of " + resultPagesPrefixes);
                grid_console.text('Data loaded.');

                var validTableBottle = false;
                var bottleObjectFields = ["id", "bottle_unique_name", "bottle_prefix", "created_date", "description"];
                var currentPageBottles = 1;
                var grid_bottles = $('#grid_bottles');
                var data_bottles = JSON.parse(grid_bottles.attr("data-bottles"));
                var resultPagesBottles = Math.ceil(data_bottles['count'] / 100);
                var changedRowIndicesBottles = [];
                var selectionRowIndicesBottles = [];
                grid_console.text('Loading data.');
                grid_bottles.handsontable({
                    //minSpareRows: 1,
                    data: data_bottles.results,
                    manualColumnResize: true,
                    manualRowResize: true,
                    invalidCellClassName: 'customHtInvalid',
                    search: {searchResultClass: 'customHtSearchResult'},
                    fillHandle: {
                        autoInsertRow: false
                    },
                    columns: [
                        {title: "ID", data: "id", readOnly: true, width: 1},
                        {title: "Unique Bottle Name", data: "bottle_unique_name", width: 150},
                        {title: "Bottle Prefix", data: "bottle_prefix_string", width: 100, type: 'autocomplete', strict: true, source: function (query, process) {
                            getValuesAjax('/mercuryservices/bottleprefixes/', 'bottle_prefix', query, process)}},
                        {title: "Date", data: "created_date", width: 100, type: 'date', dateFormat: 'MM/DD/YY', datePickerConfig: {maxDate: new Date()}},
                        {title: "Description", data: "description", width: 240}
                    ],
                    columnSorting: true,
                    //columnSorting: { column: 0 },
                    beforeChange: function(changes, source) {
                        // "changes" is a 2D array containing information about each of the edited cells [ [row, col, oldVal, newVal], [row, col, oldVal, newVal], ... ].
                        // "source" is one of the following strings: "alter", "empty", "edit", "populateFromArray", "loadData", "Autofill.fill", "CopyPaste.paste".

                        // get index of changed row
                        var changedRow = changes[0][0];

                        // remember the indices of all changed rows
                        if (source != 'loadData') {
                            // for all changed cells, get the changed rows
                            for (var i = 0; i < changes.length; i++) {
                                // get the row of this cell
                                var thisRow = changes[i][0];
                                // find index of this row in the changed rows array
                                var changedRowIndex = changedRowIndicesBottles.indexOf(thisRow);
                                // if not in the array (index == -1), add it to the array, otherwise ignore
                                if (changedRowIndex == -1) {
                                    changedRowIndicesBottles.push(thisRow);
                                }
                            }
                        }
                        //var selectedRows = grid_bottles.handsontable('getInstance').getSelectedRange();
                        //var firstSelectedRow = selectedRows['from']['row'];
                        //var lastSelectedRow = selectedRows['to']['row'];
                        //alert(firstSelectedRow+":"+lastSelectedRow);
                    },
                    // get list of selected rows
                    afterSelectionEnd: function(r, c, r2, c2) {
                        // clear the array
                        selectionRowIndicesBottles.length = 0;
                        // add the beginning and ending indices
                        selectionRowIndicesBottles[0] = r;
                        selectionRowIndicesBottles[1] = r2;
                    }
                });
                //grid_bottles.data('handsontable').sort(0);
                $('#page_bottles').html("Page " + currentPageBottles + " of " + resultPagesBottles);
                grid_console.text('Data loaded.');

                $('#search_field_prefixes').on('keyup', function (event) {
                    grid_prefixes.handsontable('getInstance').search.query(this.value);
                    grid_prefixes.handsontable('getInstance').render();
                });

                $('#search_field_bottles').on('keyup', function (event) {
                    grid_bottles.handsontable('getInstance').search.query(this.value);
                    grid_bottles.handsontable('getInstance').render();
                });

                $("#select_field_prefixes").select2({
                    multiple: true,
                    maximumSelectionSize: 1,
                    dropdownCss:{display:'none'},
                    //minimumResultsForSearch: -1,
                    //allowClear: true,
                    minimumInputLength: 1,
                    ajax: {
                        url: '/mercuryservices/bottleprefixes/',
                        dataType: 'json',
                        data: function (term, page) {
                            return {
                                bottle_prefix: term
                            };
                        },
                        results: function (data, page) {
                            data_prefixes = data;
                            grid_prefixes.data('handsontable').loadData(data_prefixes.results);
                            grid_console.text('Filtered data loaded.');
                            return {results: data.results};
                        }
                    },
                    /*sortResults: function(results, container, query) {
                        return results.sort(function (a, b) {
                            return a - b;
                        }); //sort by ID, numerically ascending
                    },*/
                    formatResult: formatprefixes,
                    formatSelection: formatprefixes
                });

                $("#select_field_bottles").select2({
                    multiple: true,
                    maximumSelectionSize: 1,
                    dropdownCss:{display:'none'},
                    //minimumResultsForSearch: -1,
                    //allowClear: true,
                    minimumInputLength: 1,
                    ajax: {
                        url: '/mercuryservices/bottles/',
                        dataType: 'json',
                        data: function (term, page) {
                            return {
                                bottle_unique_name: term
                            };
                        },
                        results: function (data, page) {
                            data_bottles = data;
                            grid_bottles.data('handsontable').loadData(data_bottles.results);
                            grid_console.text('Filtered data loaded.');
                            return {results: data.results};
                        }
                    },
                    /*sortResults: function(results, container, query) {
                        return results.sort(function (a, b) {
                            return a - b;
                        }); //sort by ID, numerically ascending
                    },*/
                    formatResult: formatbottles,
                    formatSelection: formatbottles
                });

                function formatprefixes(data) {
                    return data.bottle_prefix;
                }

                function formatbottles(data) {
                    return data.bottle_unique_name;
                }

                function clearChangedRowIndicesBottlesAdd() {
                    changedRowIndicesBottlesAdd.length = 0;
                }

                function clearChangedRowIndicesPrefixes() {
                    changedRowIndicesPrefixes.length = 0;
                }

                function clearChangedRowIndicesBottles() {
                    changedRowIndicesBottles.length = 0;
                }

                form_bottle_prefix_add.parent().find('button[name=bottle_prefix_add]').click(function () {
                    if (bottleAddClicked) {
                        bottleAddClicked = false;
                        $("#form_bottle_prefix_add").hide();
                    }
                    else {
                        rangeAddClicked = false;
                        bottleAddClicked = true;
                        bottlesAddClicked = false;
                        bottleRangeAddClicked = false;
                        $("#form_bottle_prefix_range_add").hide();
                        $("#form_bottle_prefix_add").show();
                        $("#grid_bottles_add").hide();
                        $("#bottle_range_add").hide();
                    }
                });

                form_bottle_prefix_range_add.parent().find('button[name=bottle_prefix_range_add]').click(function () {
                    if (rangeAddClicked) {
                        rangeAddClicked = false;
                        $("#form_bottle_prefix_range_add").hide();
                    }
                    else {
                        rangeAddClicked = true;
                        bottleAddClicked = false;
                        bottlesAddClicked = false;
                        bottleRangeAddClicked = false;
                        $("#form_bottle_prefix_add").hide();
                        $("#form_bottle_prefix_range_add").show();
                        $("#grid_bottles_add").hide();
                        $("#bottle_range_add").hide();
                    }
                });

                grid_bottles_add.parent().find('button[name=bottles_add]').click(function () {
                    if (bottlesAddClicked) {
                        bottlesAddClicked = false;
                        $("#grid_bottles_add").hide();
                        $("#bottle_range_add").hide();
                    }
                    else {
                        bottleAddClicked = false;
                        rangeAddClicked = false;
                        bottlesAddClicked = true;
                        bottleRangeAddClicked = false;
                        $("#form_bottle_prefix_add").hide();
                        $("#form_bottle_prefix_range_add").hide();
                        $("#grid_bottles_add").show();
                        $("#bottle_range_add").hide();
                    }
                });
                
                ////////////////////
                // Prefixes Buttons
                ////////////////////

                var tools_prefixes = $('#tools_prefixes');
                
                tools_prefixes.find('button[name=load]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    $.ajax({
                        url: '/mercuryservices/bottleprefixes/?page='+currentPagePrefixes,
                        dataType: 'json',
                        success: function (response) {
                            grid_console.text("success");
                            data_prefixes = response;
                            grid_prefixes.data('handsontable').loadData(data_prefixes.results);
                            $('#page_prefixes').html("Page " + currentPagePrefixes + " of " + resultPagesPrefixes);
                            grid_console.text('Page '+ currentPagePrefixes +' data reloaded.');
                            loading_overlay.hide();
                            button_state.button('reset');
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + ": " + textStatus + ": Couldn't retrieve page to reload.");
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                    clearChangedRowIndicesPrefixes();
                });

                tools_prefixes.find('button[name=next]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (currentPagePrefixes != resultPagesPrefixes) {
                        $.ajax({
                            url: data_prefixes.next,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_prefixes = response;
                                grid_prefixes.data('handsontable').loadData(data_prefixes.results);
                                currentPagePrefixes++;
                                $('#page_prefixes').html("Page " + currentPagePrefixes + " of " + resultPagesPrefixes);
                                grid_console.text('Page ' + currentPagePrefixes + ' of ' + resultPagesPrefixes + ' loaded.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus + ": Couldn't retrieve next page.");
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    else {
                        grid_console.text("End of results, there are no pages after Page " + resultPagesPrefixes + ".");
                        loading_overlay.hide();
                        button_state.button('reset');
                    }
                    clearChangedRowIndicesPrefixes();
                });

                tools_prefixes.find('button[name=prev]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (currentPagePrefixes != 1) {
                        $.ajax({
                            url: data_prefixes.previous,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_prefixes = response;
                                grid_prefixes.data('handsontable').loadData(data_prefixes.results);
                                currentPagePrefixes--;
                                $('#page_prefixes').html("Page " + currentPagePrefixes + " of " + resultPagesPrefixes);
                                grid_console.text('Page ' + currentPagePrefixes + ' of ' + resultPagesPrefixes + ' loaded.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus + ": Couldn't retrieve previous page.");
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    else {
                        grid_console.text("There are no pages before Page 1.");
                        loading_overlay.hide();
                        button_state.button('reset');
                    }
                    clearChangedRowIndicesPrefixes();
                });

                tools_prefixes.find('button[name=delete]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (typeof selectionRowIndicesPrefixes[0] == 'undefined') {grid_console.text('There are no selected rows to delete!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    var thisDataRow = grid_prefixes.data('handsontable').getDataAtRow(selectionRowIndicesPrefixes[0]);
                    var thisDataObject = {"id": thisDataRow[0]};
                    var changedDataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: "{% url 'merlin:bottle_prefixes_delete' %}",
                        data: changedDataJSON,
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            var content_type = jqXHRequest.getResponseHeader("content-type");
                            if (jqXHRequest.status === 200) {
                                tools_prefixes.find('button[name=load]').click();
                                grid_console.text('Data deleted.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            else {
                                tools_prefixes.find('button[name=load]').click();
                                grid_console.text(textStatus + ': Delete error: ' + jqXHRequest.statusText + ', code: ' + jqXHRequest.status + '.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + ": " + textStatus);
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                    // clear list of selected rows
                    selectionRowIndicesPrefixes.length = 0;
                });

                tools_prefixes.find('button[name=save]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var changedDataArray = [];
                    // if there are no changed rows, notify the user and stop the submission
                    if (typeof changedRowIndicesPrefixes == 'undefined' || changedRowIndicesPrefixes.length < 1) {grid_console.text('There are no changed rows to save!!'); validTablePrefix = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                    // otherwise loop through all changed rows
                    $.each(changedRowIndicesPrefixes, function(index, value) {
                        var thisDataRow = grid_prefixes.data('handsontable').getDataAtRow(value);
                        var thisDataObject = {};
                        for (var i = 0; i < thisDataRow.length; i++) {
                            if (prefixObjectFields[i] == "tare_weight") {thisDataObject[prefixObjectFields[i]] = Number(thisDataRow[i]);}
                            else if (prefixObjectFields[i] == "bottle_type") {
                                var thisID = updateValueAjax('/mercuryservices/bottletypes/', 'bottle_type_string', 'id', thisDataRow[i]);
                                if (thisID == "" || typeof thisID === 'undefined') {grid_console.text('Bottle Type must be a valid choice in row ' + (index + 1) + '!'); validTablePrefix = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                thisDataObject[prefixObjectFields[i]] = thisID;
                            }
                            else if (prefixObjectFields[i] == "created_date") {
                                var baddate = thisDataRow[i];
                                if (dateRegEx.test(baddate)) {
                                    if (makeYear(baddate)!= null && makeMonth(baddate)!= null && makeDay(baddate) != null) {
                                        var gooddate_string = makeYear(baddate) + "-" + makeMonth(baddate) + "-" + makeDay(baddate);
                                        var gooddate = new Date(makeYear(baddate), makeMonth(baddate)-1, makeDay(baddate));
                                        if (gooddate > dateToday) {
                                            {grid_console.text('Prefix Date cannot be a future date!'); validTablePrefix = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        }
                                        thisDataObject[prefixObjectFields[i]] = gooddate_string;
                                    }
                                    else {grid_console.text('There is a problem with the Date in row ' + (index + 1) + '. Please contact the administrator.'); validTablePrefix = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                }
                                else {grid_console.text('Date is badly formed in row ' + (index + 1) + '. Expecting a date in mm/dd/yy format but found ' + baddate + '!'); validTablePrefix = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                            }
                            else if (prefixObjectFields[i] == "description") {
                                if (thisDataRow[i] == null) {
                                    thisDataRow[i] = "";
                                }
                                thisDataObject[prefixObjectFields[i]] = thisDataRow[i];
                            }
                            else {thisDataObject[prefixObjectFields[i]] = thisDataRow[i];}
                        }
                        changedDataArray.push(thisDataObject);
                        // if we made it through the various validations above, then the table must be valid
                        validTablePrefix = true;
                    });
                    // if table is valid, submit the POST request, otherwise skip it (implying table is invalid)
                    if(validTablePrefix) {
                        var changedDataJSON = JSON.stringify(changedDataArray);
                        $.ajax({
                            url: "{% url 'merlin:bottle_prefixes_update' %}",
                            data: changedDataJSON,
                            dataType: 'json',
                            contentType: "application/json",
                            type: 'POST',
                            success: function (data, textStatus, jqXHRequest) {
                                var content_type = jqXHRequest.getResponseHeader("content-type");
                                // if the content-type is plain text, then it's a custom message from our Django view
                                if (content_type.indexOf('text') > -1) {
                                    grid_console.text(data);
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                                // otherwise, it's JSON from the REST Services
                                else if (jqXHRequest.status === 200) {
                                    grid_console.text(textStatus + ': Data saved.');
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                                else {
                                    grid_console.text(textStatus + ': Save error: ' + jqXHRequest.statusText + ', code: ' + jqXHRequest.status + '.');
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus);
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    clearChangedRowIndicesPrefixes();
                });
                
                ////////////////////
                // Bottles Buttons
                ////////////////////

                var tools_bottles = $('#tools_bottles');
                
                tools_bottles.find('button[name=load]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    $.ajax({
                        url: '/mercuryservices/bottles/?page='+currentPageBottles,
                        dataType: 'json',
                        success: function (response) {
                            grid_console.text("success");
                            data_bottles = response;
                            grid_bottles.data('handsontable').loadData(data_bottles.results);
                            $('#page_bottles').html("Page " + currentPageBottles + " of " + resultPagesBottles);
                            grid_console.text('Page '+ currentPageBottles +' data reloaded.');
                            loading_overlay.hide();
                            button_state.button('reset');
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + ": " + textStatus + ": Couldn't retrieve page to reload.");
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                    clearChangedRowIndicesBottles();
                });

                tools_bottles.find('button[name=next]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (currentPageBottles != resultPagesBottles) {
                        $.ajax({
                            url: data_bottles.next,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_bottles = response;
                                grid_bottles.data('handsontable').loadData(data_bottles.results);
                                currentPageBottles++;
                                $('#page_bottles').html("Page " + currentPageBottles + " of " + resultPagesBottles);
                                grid_console.text('Page ' + currentPageBottles + ' of ' + resultPagesBottles + ' loaded.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus + ": Couldn't retrieve next page.");
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    else {
                        grid_console.text("End of results, there are no pages after Page " + resultPagesBottles + ".");
                        loading_overlay.hide();
                        button_state.button('reset');
                    }
                    clearChangedRowIndicesBottles();
                });

                tools_bottles.find('button[name=prev]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (currentPageBottles != 1) {
                        $.ajax({
                            url: data_bottles.previous,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_bottles = response;
                                grid_bottles.data('handsontable').loadData(data_bottles.results);
                                currentPageBottles--;
                                $('#page_bottles').html("Page " + currentPageBottles + " of " + resultPagesBottles);
                                grid_console.text('Page ' + currentPageBottles + ' of ' + resultPagesBottles + ' loaded.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus + ": Couldn't retrieve previous.");
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    else {
                        grid_console.text("There are no pages before Page 1.");
                        loading_overlay.hide();
                        button_state.button('reset');
                    }
                    clearChangedRowIndicesBottles();
                });

                tools_bottles.find('button[name=delete]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (typeof selectionRowIndicesBottles[0] == 'undefined') {grid_console.text('There are no selected rows to delete!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    var thisDataRow = grid_bottles.data('handsontable').getDataAtRow(selectionRowIndicesBottles[0]);
                    var thisDataObject = {"id": thisDataRow[0]};
                    var changedDataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: "{% url 'merlin:bottles_delete' %}",
                        data: changedDataJSON,
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            var content_type = jqXHRequest.getResponseHeader("content-type");
                            if (jqXHRequest.status === 200) {
                                tools_bottles.find('button[name=load]').click();
                                grid_console.text('Data deleted.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            else {
                                tools_bottles.find('button[name=load]').click();
                                grid_console.text(textStatus + ': Delete error: ' + jqXHRequest.statusText + ', code: ' + jqXHRequest.status + '.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + ": " + textStatus);
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                    // clear list of selected rows
                    selectionRowIndicesBottles.length = 0;
                });

                tools_bottles.find('button[name=save]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var changedDataArray = [];
                    // if there are no changed rows, notify the user and stop the submission
                    if (typeof changedRowIndicesBottles == 'undefined' || changedRowIndicesBottles.length < 1) {grid_console.text('There are no changed rows to save!!'); validTableBottle = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                    // otherwise loop through all changed rows
                    $.each(changedRowIndicesBottles, function(index, value) {
                        var thisDataRow = grid_bottles.data('handsontable').getDataAtRow(value);
                        var thisDataObject = {};
                        for (var i = 0; i < thisDataRow.length; i++) {
                            if (bottleObjectFields[i] == "bottle_prefix") {
                                var thisID = updateValueAjax('/mercuryservices/bottleprefixes/', 'bottle_prefix', 'id', thisDataRow[i]);
                                if (thisID == "" || typeof thisID === 'undefined') {grid_console.text('Bottle Prefix must be a valid choice in row ' + (index + 1) + '!'); validTableBottle = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                thisDataObject[bottleObjectFields[i]] = thisID;
                            }
                            else if (bottleObjectFields[i] == "created_date") {
                                var baddate = thisDataRow[i];
                                if (dateRegEx.test(baddate)) {
                                    if (makeYear(baddate)!= null && makeMonth(baddate)!= null && makeDay(baddate) != null) {
                                        var gooddate_string = makeYear(baddate) + "-" + makeMonth(baddate) + "-" + makeDay(baddate);
                                        var gooddate = new Date(makeYear(baddate), makeMonth(baddate)-1, makeDay(baddate));
                                        if (gooddate > dateToday) {
                                            {grid_console.text('Bottle Date cannot be a future date!'); validTableBottle = false; button_state.button('reset'); return false;}
                                        }
                                        thisDataObject[bottleObjectFields[i]] = gooddate_string;
                                    }
                                    else {grid_console.text('There is a problem with the Date in row ' + (index + 1) + '. Please contact the administrator.'); validTableBottle = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                }
                                else {grid_console.text('Date is badly formed in row ' + (index + 1) + '. Expecting a date in mm/dd/yy format but found ' + baddate + '!'); validTableBottle = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                            }
                            else if (prefixObjectFields[i] == "description") {
                                if (thisDataRow[i] == null) {
                                    thisDataRow[i] = "";
                                }
                                thisDataObject[bottleObjectFields[i]] = thisDataRow[i];
                            }
                            else {thisDataObject[bottleObjectFields[i]] = thisDataRow[i];}
                        }
                        changedDataArray.push(thisDataObject);
                        // if we made it through the various validations above, then the table must be valid
                        validTableBottle = true;
                    });
                    // if table is valid, submit the POST request, otherwise skip it (implying table is invalid)
                    if(validTableBottle) {
                        var changedDataJSON = JSON.stringify(changedDataArray);
                        $.ajax({
                            url: "{% url 'merlin:bottles_update' %}",
                            data: changedDataJSON,
                            dataType: 'json',
                            contentType: "application/json",
                            type: 'POST',
                            success: function (data, textStatus, jqXHRequest) {
                                var content_type = jqXHRequest.getResponseHeader("content-type");
                                // if the content-type is plain text, then it's a custom message from our Django view
                                if (content_type.indexOf('text') > -1) {
                                    grid_console.text(data);
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                                // otherwise, it's JSON from the REST Services
                                else if (jqXHRequest.status === 200) {
                                    grid_console.text(textStatus + ': Data saved.');
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                                else {
                                    grid_console.text(textStatus + ': Save error: ' + jqXHRequest.statusText + ', code: ' + jqXHRequest.status + '.');
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                            },
                            error: function (jqXHRequest, textStatus, errorThrown) {
                                grid_console.text(errorThrown + ": " + textStatus);
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    clearChangedRowIndicesBottles();
                });

            });
        </script>

    </div>

{% endblock %}