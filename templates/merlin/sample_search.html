{% extends 'merlin/base.html' %}
{% block body_block %}


    <div id="loading_overlay"></div>
    <div style="padding:10px">
        <pre id="grid_console" class="console" style="width:600px"></pre>
        <pre id="grid_console_error" class="alert alert-warning" style="width:600px;display:none;"></pre>
        <div class="panel-default">
            <form id="form_result_search" class="form-inline">
                {% csrf_token %}
                <p>
                    <div class="form-group">
                        <label for="select_bottle">Bottle Code</label><!-- <br /> -->
                        <!-- <button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#multiBottleSearchModal"> -->
                            <span class="glyphicon glyphicon-search" data-toggle="modal" data-target="#multiBottleSearchModal"></span><br />
                        <!-- </button><br /> -->
                        <input id="select_bottle" type="hidden" style="width:963px"/>
                    </div>
                    <div class="form-group">
                        <label for="select_analysis_bottle">Analysis</label><br />
                        <input id="select_analysis_bottle" type="hidden" style="width:237px"/>
                    </div>
                </p>
                <br />
                <p>OR</p>
                <br />
                <p>
                    <div class="form-group">
                        <label for="select_project">Project Name</label><br />
                        <input id="select_project" type="hidden" style="width:598px"/>
                    </div>
                    <div class="form-group">
                        <label for="select_site">Site Name</label><br />
                        <input id="select_site" type="hidden" style="width:598px"/>
                    </div>
                </p>
                <p>
                    <div class="form-group">
                        <label for="date_after_sample">After Sample Date</label><br />
                        <input id="date_after_sample" class="select2-container select2-container-multi" style="width:237px;height:34px;font-size:15px;padding-left:4px;"/>
                    </div>
                    <div class="form-group">
                        <label for="date_before_sample">Before Sample Date</label><br />
                        <input id="date_before_sample" class="select2-container select2-container-multi" style="width:237px;height:34px;font-size:15px;padding-left:4px;"/>
                    </div>
                    <div class="form-group">
                        <label for="select_depth">Depth</label><br />
                        <input id="select_depth" type="number" class="select2-container select2-container-multi" style="width:237px;height:34px;font-size:15px;padding-left:4px;"/>
                    </div>
                    <div class="form-group">
                        <label for="select_replicate">Replicate</label><br />
                        <input id="select_replicate" type="number" class="select2-container select2-container-multi" style="width:237px;height:34px;font-size:15px;padding-left:4px;"/>
                    </div>
                    <div class="form-group">
                        <label for="select_analysis">Analysis</label><br />
                        <input id="select_analysis" type="hidden" style="width:237px"/>
                    </div>
                </p>
                <p>
                    <button type="button" class="btn btn-info" data-loading-text="Searching..." name="search">Search</button>
                    <button type="button" class="btn btn-default" name="exportCSV">Export CSV</button>
                    <button type="button" class="btn btn-default" data-loading-text="Getting Previous..." name="prev">Previous Page</button>
                    <button type="button" class="btn btn-default" data-loading-text="Getting Next..." name="next">Next Page</button>
                    <label for="lookupContainers" style="margin-left:75px">Lookup Container IDs</label>
                    <input type="checkbox" name="lookupContainers" id="lookupContainers" />
                </p>
                <div id="exportCSVButtonPanel" style="display:none" >
                    <button type="button" class="btn btn-info" data-loading-text="Exporting..." name="exportCSVCurrentPage">Current Page</button>
                    <button type="button" class="btn btn-info" data-loading-text="Exporting..." name="exportCSVAllPages">All Pages</button>
                    <span id="note">NOTE: Each page requested takes about 0.33 seconds to process, e.g. 100 pages will take about 33 seconds.</span>
                </div><br />
                <p>
                    {% if request.session.is_staff %}
                    <button type="button" class="btn btn-warning" data-loading-text="Saving..." name="save">Save</button>
                    <button type="button" class="btn btn-default" data-loading-text="Inserting..." name="insert">Clone Sample</button>
                    <button type="button" class="btn btn-default" data-loading-text="Removing..." name="remove">Remove Clone</button>
                    {% endif %}
                </p>
            </form>
        </div>

        <p>
            <div class="select2-container select2-container-multi" style="width:600px">
                <ul class="select2-choices">
                    <li class="select2-search-field">
                        <label class="select2-offscreen"></label>
                        <input id="search_field" type="search" placeholder="Highlight in table." class="select2-input select2-default" style="width:593px;height:40px;font-size:21px;"/>
                    </li>
                </ul>
            </div>
        <!-- <p><input id="search_field" type="search" placeholder="Highlight in table." style="width:600px; border:1px solid darkgray; height:42px"/></p> -->
        <br /><br />
        <div id="grid" data-projects="{{ projects }}" data-processings="{{ processings }}" data-analyses="{{ analyses }}" data-constituents="{{ constituents }}" data-mediums="{{ mediums }}" data-filters="{{ filters }}" data-preservations="{{ preservations }}" data-isotopeflags="{{ isotope_flags }}" ></div>
        <div id="tempgrid" style="display:none"></div>

                    <!-- Multi Bottle Search Modal -->
        <div class="modal fade" id="multiBottleSearchModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Multi Bottle Search</h4>
              </div>
              <div class="modal-body">
                <textarea id="bottle_search_list" style="width:100%;height: 200px;"></textarea>
                <div class="alert alert-warning" role="alert" style="display:none">...</div>
                <div class="form-group">
                  <label for="select_analysis_bottle_modal">Analysis</label><br />
                  <input id="select_analysis_bottle_modal" type="hidden" style="width:237px"/>
                </div>
              </div>
              <div class="modal-footer">
                  <button id="multi_bottle_search" type="button" class="btn btn-info" data-loading-text="Searching...">Search</button>
                  <!-- <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> -->
              </div>
            </div>
          </div>
        </div>

		<script>
            $(document).ready(function() {

				var loading_overlay = $('#loading_overlay');
				loading_overlay.hide();

                var csrftoken = $.cookie('csrftoken');
                function csrfSafeMethod(method) {
                    // these HTTP methods do not require CSRF protection
                    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                }
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });

                var currentPage = 1;
                var resultPages = 1;
                var validTable = false;
                var exportCSVClicked = false;
                var grid = $('#grid');
                var grid_console = $("#grid_console");
                var data_data;
                grid.css("z-index", "0");
                var data_processings = JSON.parse(grid.attr('data-processings'));
                var data_mediums = JSON.parse(grid.attr('data-mediums'));
                for (var key in data_mediums) {
                        var item = data_mediums[key];
                        item.display_text = item.nwis_code + " - " + item.medium;
                    }
                var data_filters = JSON.parse(grid.attr('data-filters'));
                var data_preservations = JSON.parse(grid.attr('data-preservations'));
                var data_isotopeflags = JSON.parse(grid.attr('data-isotopeflags'));
                data_isotopeflags.sort(function (a, b) {
                    var textA = a.isotope_flag.toUpperCase();
                    var textB = b.isotope_flag.toUpperCase();
                    return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
                }); //sort alphabetically
                var data_acids;
                var data_projects = JSON.parse(grid.attr('data-projects'));
                var data_sites;
                var data_analyses = JSON.parse(grid.attr('data-analyses'));
                var data_constituents = JSON.parse(grid.attr('data-constituents'));
                var bottleIds = [];
                var penultimateSearchWasMultiBottle = false;
                function split( val ) {return val.split( /,/ );}
                var validateTime = function(value, callback) {
                    // convert the string to number to allow math operations; also trims off leading zeroes
                    value = Number(value);
                    switch (value.toString().length) {
                        case 2: // between 12:09am and 1:00am (00:xx)
                            // minutes must be less than 60
                            if(value < 60){callback(true);}
                            else {callback(false);}
                            break;
                        case 3: // between 1am and 10am (1:xx thru 9:xx)
                            // convert to string to extract the minutes, then convert back to number to test if less than 60 (all single digit hours (1 thru 9) are allowed and thus not tested)
                            if(Number(value.toString().substring(1,3)) < 60){callback(true);}
                            else {callback(false);}
                            break;
                        case 4: // after 10am (10:xx thru xx:xx)
                            // convert to string to separately extract hours and minutes, then convert back to number to test if less than 24 and 60, respectively
                            if(Number(value.toString().substring(0,2)) < 24 && Number(value.toString().substring(2,4)) < 60){callback(true);}
                            else {callback(false);}
                            break;
                        default: // any other cases (1 digit, 00:00 thru 00:09) are allowed; column is already limited to 4 digits in the constructor, so no need to test for cases of 5 or more digits
                            {callback(true);}
                            break;
                    }
                };
                var objectFields = ["sample_bottle.sample.id", "project_name", "project", "site", "site_id", "skip_date", "sample_date_time", "depth", "length", "replicate", "comment", "received_date", "lab_processing", "bottle", "medium_type", "analysis_type", "constituent_type", "isotope_flag", "filter_type", "volume_filtered", "preservation_type", "preservation_acid", "preservation_volume", "preservation_comment", "sample_bottle.id", "id"];
                var changedRowIndices = [];
                var selectionRowIndices = [];
                var dateToday = new Date(); //toISOString().split("T")[0];
                var yearToday = dateToday.getFullYear().toString();
                var monthToday = (dateToday.getMonth() + 1).toString();
                var dayToday = dateToday.getDate().toString();
                function insertRenderer(instance, td, row, col, prop, value, cellProperties) {
                    if ([6,7,8,9,19,22].indexOf(col) > -1) {Handsontable.renderers.NumericRenderer.apply(this, arguments);}
                    else if ([1,2,3,4,12,14,15,16,17,18,20].indexOf(col) > -1) {Handsontable.renderers.AutocompleteRenderer.apply(this, arguments);}
                    else {Handsontable.renderers.TextRenderer.apply(this, arguments);}
                    td.style.backgroundColor = '#88CC00';
                    return td;
                }
                var grid_columns = [
                        {title: 'Sample ID', data: 'sample_bottle.sample.id', readOnly: true, width: 75},
                        {title: 'Project Name', data: 'sample_bottle.sample.project_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 100, type: 'autocomplete', strict: true, source: function (query, process) {
                            getValuesAjax('/merlinservices/projects/', 'name', query, process)}
                        },
                        {title: 'Project ID', data: 'sample_bottle.sample.project', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 1, type: 'autocomplete', strict: true, source: function (query, process) {
                            getValuesAjax('/merlinservices/projects/', 'id', query, process)}
                        },
                        {title: 'Site Name', data: 'sample_bottle.sample.site_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 75, type: 'autocomplete', strict: true, source: function (query, process) {
                            getValuesAjax('/merlinservices/sites/', 'name', query, process, ('project=' + grid.handsontable('getInstance').getDataAtCell(selectionRowIndices[0], 2)))}
                        },
                        {title: 'Site ID', data: 'sample_bottle.sample.site_usgs_scode', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 70, type: 'autocomplete', strict: true, source: function (query, process) {
                            getValuesAjax('/merlinservices/sites/', 'usgs_scode', query, process, ('project=' + grid.handsontable('getInstance').getDataAtCell(selectionRowIndices[0], 2)))}
                        },
                        // Date, Hour, and Minute as separate columns is temporary until a single column datetime editor can be found for handsontable
                        {title: 'Date', data: 'sample_bottle.sample.sample_date', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 85, type: 'date', dateFormat: 'MM/DD/YY', datePickerConfig: {maxDate: new Date()}},
                        {title: 'Time', data: 'sample_bottle.sample.sample_time', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 55, type: 'numeric', validator: validateTime},
                        //{title: 'Hour', width: 50, type: 'autocomplete', source: getRange(24)},
                        //{title: 'Minute', width: 50, type: 'autocomplete', source: getRange(60)},
                        {title: 'Depth', data: 'sample_bottle.sample.depth', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 50, type: 'numeric', numericFormat: {pattern: '0.0000', culture: 'en-US'}},
                        {title: 'Length', data: 'sample_bottle.sample.length', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 50, type: 'numeric'},
                        {title: 'Rep', data: 'sample_bottle.sample.replicate', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 35, type: 'numeric'},
                        {title: 'Sample Comments', data: 'sample_bottle.sample.comment', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 130, type: 'text'},
                        {title: 'Received', data: 'sample_bottle.sample.received_date', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 90, type: 'date', dateFormat: 'MM/DD/YY', datePickerConfig: {maxDate: new Date()}},
                        {title: 'Lab Processing', data: 'sample_bottle.sample.lab_processing_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 105, type: 'autocomplete', strict: true, source: getValuesDom(data_processings,"processing")},
                        //{title: 'Container ID', width: 110, type: 'autocomplete', strict: true, validator: validateRequired,  source: function (query, process) {
                        //    getValuesAjax('/merlinservices/bottles/', 'bottle_unique_name', query, process)}},
                        {title: 'Container ID', data: 'sample_bottle.bottle.bottle_unique_name', width: 110, type: 'text'},
                        {title: 'Medium', data: 'sample_bottle.sample.medium_type_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 100, type: 'autocomplete', strict: true, source: getValuesDom(data_mediums,"display_text")},
                        {title: 'Analysis', data: 'analysis_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 80, type: 'autocomplete', strict: true, source: function (query, process) {
                            getValuesAjax('/merlinservices/analyses/', 'analysis', query, process, ('medium=' + getIdDom(data_mediums,'display_text', grid.handsontable('getInstance').getDataAtCell(selectionRowIndices[0], 14))))}
                        },
                        {title: 'Constituent', 'data': 'constituent_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 140, type: 'autocomplete', strict: true, source: function (query, process) {
                            getValuesAjax('/merlinservices/constituents/', 'constituent', query, process, ('analysis=' + getIdDom(data_analyses,'analysis', grid.handsontable('getInstance').getDataAtCell(selectionRowIndices[0], 15))))}
                        },
                        {title: 'Isotope', data: 'isotope_flag_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 55, type: 'dropdown', source: getValuesDom(data_isotopeflags,"isotope_flag")},
                        {title: 'Filter', data: 'sample_bottle.filter_type_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 60, type: 'autocomplete', strict: true, source: getValuesDom(data_filters,"filter")},
                        {title: 'Filter Vol.', data: 'sample_bottle.volume_filtered', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 65, type: 'numeric', format: '0.00'},
                        {title: 'Preservation', data: 'sample_bottle.preservation_type_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 100, type: 'autocomplete', strict: true, source: getValuesDom(data_preservations, "preservation")},
                        //{title: 'Acid', width: 100, type: 'autocomplete',  source: getValuesDom(data_acids, "code")},
                        {title: 'Acid', data: 'sample_bottle.preservation_acid_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 110, type: 'autocomplete', strict: true,  source: function (query, process) {
                            getValuesAjax('/merlinservices/acids/', 'code', query, process)}},
                        {title: 'Acid Vol.', data: 'sample_bottle.preservation_volume', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 60, type: 'numeric', format: '0.00'},
                        {title: 'Pres. Comments', data: 'sample_bottle.preservation_comment', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 115, type: 'text'},
                        {title: 'Sample Bottle ID', data: 'sample_bottle.id', readOnly: true, width: 1},
                        {title: 'Result ID', data: 'id', readOnly: true, width: 1}
                    ];
                var grid_options = {
                    startRows: 0,
                    fillHandle: {
                        autoInsertRow: false
                    },
                    data: data_data,
                    {% if request.session.is_staff %} currentRowClassName: 'customCurrentRow', {% endif %}
                    manualColumnResize: true,
                    manualRowResize: true,
                    invalidCellClassName: 'customHtInvalid',
                    search: {searchResultClass: 'customHtSearchResult'},
                    columns: grid_columns,
                    cells: function (row, col, prop) {
                        var cellProperties = {};
                        // if the Result ID value is null, then this is an inserted (cloned) row
                        if (grid.handsontable('getInstance').getDataAtCell(row, 25) == null) {cellProperties.renderer = insertRenderer;}
                        return cellProperties;
                    },
                    columnSorting: true,
                    // define event handlers
                    beforeChange: function(changes, source) {
                        // "changes" is a 2D array containing information about each of the edited cells [ [row, col, oldVal, newVal], [row, col, oldVal, newVal], ... ].
                        // "source" is one of the following strings: "alter", "empty", "edit", "populateFromArray", "loadData", "autofill", "paste".

                        // get index of changed row
                        var changedRow = changes[0][0];
                        // get index of changed column
                        var changedCol = changes[0][1];
                        // get value of changed cell
                        var changedVal = changes[0][3];

                        // remember the indices of all changed rows
                        if (source != 'loadData') {
                            // find index of this row in the changed rows array
                            var changedRowIndex = changedRowIndices.indexOf(changedRow);
                            // if not in the array (index == -1), add it to the array, otherwise ignore
                            if (changedRowIndex == -1){
                                changedRowIndices.push(changedRow);
                            }
                        }

                        // update dependent columns when a value in a parent column is changed
                        if (source == 'edit') {
                            // when project name is changed to a non-null, non-blank value
                            if (changedCol == 'sample_bottle.sample.project_string' && changedVal !== null && changedVal !== "") {
                                // update project ID to match project name
                                var newValue = updateValueDom(data_projects, 'name', 'id', changedVal);
                                grid.handsontable('setDataAtCell', changedRow, 2, newValue);
                                // update lists of site names and IDs filtered by the selected project name
                                $.ajax({
                                    url: '/merlinservices/sites/',
                                    dataType: 'json',
                                    data: {
                                        project: changedVal
                                    },
{#                                    success: function (response) {#}
{#                                        grid_console.text("success");#}
{#                                        // update the local full object collection#}
{#                                        data_sites = response['results'];#}
{#                                        // update the site name dropdown list with just the values#}
{#                                        var colToChange = 2;#}
{#                                        var values = getValuesDom(data_sites, "name");#}
{#                                        var cellProperties = grid.handsontable('getInstance').getCellMeta(changedRow, colToChange);#}
{#                                        cellProperties.source = values;#}
{#                                        // update the site IDs dropdown list with just the IDs#}
{#                                        colToChange = 3;#}
{#                                        values = getValuesDom(data_sites, "id");#}
{#                                        cellProperties = grid.handsontable('getInstance').getCellMeta(changedRow, colToChange);#}
{#                                        cellProperties.source = values;#}
{#                                    },#}
                                    success: function (response) {
                                        grid_console.text("success");
                                        // update the site name dropdown list with just the values
                                        colToChange = 3;
                                        // if there is a previously entered value in this cell, set it to null, otherwise leave it alone (this avoids unnecessary triggering of cell validation)
                                        if (grid.handsontable('getDataAtCell', changedRow, colToChange) != null) {
                                            grid.handsontable('setDataAtCell', changedRow, colToChange, null);
                                        }
                                        var cellProperties = grid.handsontable('getInstance').getCellMeta(changedRow, colToChange);
                                        cellProperties.source = getValuesDom(response['results'], "name");
                                        // update the site IDs dropdown list with just the IDs
                                        colToChange = 4;
                                        // if there is a previously entered value in this cell, set it to null, otherwise leave it alone (this avoids unnecessary triggering of cell validation)
                                        if (grid.handsontable('getDataAtCell', changedRow, colToChange) != null) {
                                            grid.handsontable('setDataAtCell', changedRow, colToChange, null);
                                        }
                                        cellProperties = grid.handsontable('getInstance').getCellMeta(changedRow, colToChange);
                                        cellProperties.source = getValuesDom(response['results'], "usgs_scode");
                                    },
                                    error: function (response) {
                                        grid_console.text("error");
                                    }
                                });
                            }
                            // when site name is changed to a non-null, non-blank value
                            if (changedCol == 'sample_bottle.sample.site_string' && changedVal !== null && changedVal !== "") {
                                // update site ID to match site name
                                var newValue = updateValueAjax('/merlinservices/sites/', 'name', 'usgs_scode', changedVal, ('project=' + grid.handsontable('getInstance').getDataAtCell(changedRow, 2)));
                                grid.handsontable('setDataAtCell', changedRow, 4, newValue);
                            }
                            // when site ID is changed to a non-null, non-blank value
                            if (changedCol == 'sample_bottle.sample.site_usgs_scode' && changedVal !== null && changedVal !== "") {
                                // update site name to match site ID
                                var newValue = updateValueAjax('/merlinservices/sites/', 'usgs_scode', 'name', changedVal, ('project=' + grid.handsontable('getInstance').getDataAtCell(changedRow, 2)));
                                grid.handsontable('setDataAtCell', changedRow, 3, newValue);
                            }
                            // when medium is changed to a non-null, non-blank value
                            if (changedCol == 'sample_bottle.sample.medium_type_string' && changedVal !== null && changedVal !== "") {
                                var thisVal = updateValueDom(data_mediums, 'display_text', 'nwis_code', changedVal);
                                // update list of analyses filtered by the selected medium value
                                $.ajax({
                                    url: '/merlinservices/analyses/',
                                    dataType: 'json',
                                    data: {
                                        nwis_code: thisVal
                                    },
                                    success: function (response) {
                                        grid_console.text("success");
                                        var colToChange = 15;
                                        // if there is a previously entered value in this cell, set it to null, otherwise leave it alone (this avoids unnecessary triggering of cell validation)
                                        if (grid.handsontable('getDataAtCell', changedRow, colToChange) != null) {
                                            grid.handsontable('setDataAtCell', changedRow, colToChange, null);
                                        }
                                        // update the local full object collection
                                        data_analyses = response;
                                        // update the dropdown list with just the values
                                        var values = getValuesDom(data_analyses, "analysis");
                                        var cellProperties = grid.handsontable('getInstance').getCellMeta(changedRow, colToChange);
                                        cellProperties.source = values;
                                        // also empty the constituents cell (but don't populate its dropdown because that is dependent on the user-chosen analysis)
                                        colToChange = 16;
                                        // if there is a previously entered value in this cell, set it to null, otherwise leave it alone (this avoids unnecessary triggering of cell validation)
                                        if (grid.handsontable('getDataAtCell', changedRow, colToChange) != null) {
                                            grid.handsontable('setDataAtCell', changedRow, colToChange, null);
                                        }
                                    },
                                    error: function (response) {
                                        grid_console.text("error");
                                    }
                                });
                            }
                            // when analysis is changed
                            if (changedCol == 'analysis_string') {
                                var analysisVal = grid.handsontable('getDataAtCell', changedRow, 15);
                                var analysisID = getIdDom(data_analyses,'analysis', analysisVal);
                                // update list of constituents filtered by the current analysis value
                                $.ajax({
                                    url: '/merlinservices/constituents/',
                                    dataType: 'json',
                                    data: {
                                        analyses: analysisID
                                    },
                                    success: function (response) {
                                        grid_console.text("success");
                                        var colToChange = 16;
                                        // if there is a previously entered value in this cell, set it to null, otherwise leave it alone (this avoids unnecessary triggering of cell validation)
                                        if (grid.handsontable('getDataAtCell', changedRow, colToChange) != null) {
                                            grid.handsontable('setDataAtCell', changedRow, colToChange, null);
                                        }
                                        // update the local full object collection
                                        data_constituents = response;
                                        // update the dropdown list with just the values
                                        var values = getValuesDom(data_constituents, "constituent");
                                        var cellProperties = grid.handsontable('getInstance').getCellMeta(changedRow, colToChange);
                                        cellProperties.source = values;
                                    },
                                    error: function (response) {
                                        grid_console.text("error");
                                    }
                                });
                            }
                        }
                    },
                    // get list of selected rows
                    afterSelectionEnd: function(r, c, r2, c2) {
                        // clear the array
                        selectionRowIndices.length = 0;
                        // add the beginning and ending indices
                        selectionRowIndices[0] = r;
                        selectionRowIndices[1] = r2;

                    }
                };
                grid_console.text('Loading data...');
                grid.handsontable(grid_options);
                //grid.data('handsontable').sort(0);
                grid_console.text('Data loaded.');

                $('#search_field').on('keyup', function (event) {
                    grid.handsontable('getInstance').search.query(this.value);
                    grid.handsontable('getInstance').render();
                });

                var select_bottle = $("#select_bottle").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    ajax: {
                        url: '/merlinservices/bottles/',
                        dataType: 'json',
                        data: function (term, page) {
                            return {
                                bottle_unique_name: term
                            };
                        },
                        results: function (data, page) {
                            //data_data = data;
                            //grid.data('handsontable').loadData(data.results);
                            // also clear the multi-bottle modal search so it doesn't interfere with main form search
                            $("#bottle_search_list").val("");
                            $("#select_analysis_bottle_modal").select2('val', '');
                            grid_console.text('Filtered data loaded.');
                            return {results: data.results};
                        }
                    },
                    formatResult: formatBottle,
                    formatSelection: formatBottle
                });

                var select_analysis_bottle = $("#select_analysis_bottle").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    data: { results: data_analyses, text: 'analysis'},
                    formatResult: formatAnalysis,
                    formatSelection: formatAnalysis
                });

                $('#select_analysis_bottle').on("select2-selecting", function(e) {
                    // clear the multi-bottle modal search so it doesn't interfere with main form search
                    $("#bottle_search_list").val("");
                    $("#select_analysis_bottle_modal").select2('val', '');
                });

                var select_analysis_bottle_modal = $("#select_analysis_bottle_modal").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    data: { results: data_analyses, text: 'analysis'},
                    formatResult: formatAnalysis,
                    formatSelection: formatAnalysis
                });

                $('#select_analysis_bottle_modal').on("select2-selecting", function(e) {
                    // clear the main form search so it doesn't interfere with multi-bottle modal search
                    $("#select_bottle").val("");
                    $("#select_analysis_bottle").select2('val', '');
                });

                var select_project = $("#select_project").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    data: { results: data_projects, text: 'name'},
                    formatResult: formatName,
                    formatSelection: formatName
                });//.on("change", function(e) {});

                var select_site = $("#select_site").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    ajax: {
                        url: '/merlinservices/sites/',
                        dataType: 'json',
                        data: function (term, page) {
                            return {
                                name: term
                            };
                        },
                        results: function (data, page) {
                            grid_console.text('Filtered data loaded.');
                            return {results: data.results};
                        }
                    },
                    formatResult: formatName,
                    formatSelection: formatName
                });

                var select_analysis = $("#select_analysis").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    data: { results: data_analyses, text: 'analysis'},
                    formatResult: formatAnalysis,
                    formatSelection: formatAnalysis
                });

                function formatName(data) {
                    return data.name;
                    /*var newData = [];
                    $.each(data, function(item){
                       newData.push({
                           id: item.id,
                           text: item.name
                       })
                    });
                    return newData;*/
                }

                function formatID(data) {
                    return data.id;
                }

                function formatBottle(data) {
                    return data.bottle_unique_name;
                }

                function formatAnalysis(data) {
                    return data.analysis;
                }

                function clearChangedRowIndices() {
                    changedRowIndices.length = 0;
                }

                var date_after_sample = new Pikaday({
                    field: $('#date_after_sample')[0],
                    format: 'MM/DD/YY',
                    maxDate: new Date()
                });

                var date_before_sample = new Pikaday({
                    field: $('#date_before_sample')[0],
                    format: 'MM/DD/YY',
                    maxDate: new Date()
                });

                //var date_after_sample = $("#date_after_sample").datepicker({
                //    dateFormat: "mm/dd/y",
                //    maxDate: 0
                //});

                //var date_before_sample = $("#date_before_sample").datepicker({
                //    dateFormat: "mm/dd/y",
                //    maxDate: 0
                //});

                grid.parent().find('button[name=search]').click(function(){
                    $("#grid_console_error").hide();
                    searchBottles('button[name=search]',$("#select_bottle").val(),$("#select_analysis_bottle").val());
                });

                var searchBottles = function(button,bottle,analysis){
                    penultimateSearchWasMultiBottle = (button == '#multi_bottle_search');
                    var button_state = $(button).button('loading');
                    loading_overlay.show();
                    grid_console.text('Attempting to search...');
                    var thisDataObject = {};
                    //var theID = $(select_project).select2('data').id;
                    //var theSelection = $(select_project).select2('data').text;
                    thisDataObject['bottle'] = bottle;
                    thisDataObject['project'] = $(select_project).val();
                    thisDataObject['site'] = $(select_site).val();//.slice(0, -1);
                    thisDataObject['depth'] = $("#select_depth").val();
                    thisDataObject['replicate'] = $("#select_replicate").val();
                    if (bottle !== "" && analysis !== "") {
                        thisDataObject['analysis'] = analysis;
                    }
                    else if (bottle === "") {
                        thisDataObject['analysis'] = $(select_analysis).val();
                    }
                    else {
                        thisDataObject['analysis'] = "";
                    }
                    thisDataObject['date_after_sample'] = date_after_sample.toString('MM/DD/YY');
                    thisDataObject['date_before_sample'] = date_before_sample.toString('MM/DD/YY');
                    thisDataObject['page_size'] = "";
                    thisDataObject['format'] = "";
                    thisDataObject['table'] = "";
                    var dataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: "{% url 'merlin:samples_search' %}",
                        data: dataJSON,
                        dataType: 'json',
                        contentType: "application/json",
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            var content_type = jqXHRequest.getResponseHeader("content-type");
                            // if the content-type is plain text, then it's a custom message from our Django view
                            if (content_type.indexOf('text') > -1) {
                                grid_console.text(data);
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            // otherwise, it's JSON from the REST Services
                            else if (jqXHRequest.status === 200) {
                                data_data = data;
                                for (var row in data_data.results) {
                                    var medium_original = data_data.results[row]['sample_bottle']['sample']['medium_type_string'];
                                    data_data.results[row]['sample_bottle']['sample']['medium_type_string'] = updateValueDom(data_mediums, 'nwis_code', 'display_text', medium_original);
                                }
                                resultPages = Math.ceil(data_data['count'] / 100);
                                grid_console.text(textStatus+': Retrieved '+ data_data['count'] +' results across ' + resultPages + ' pages.' + (resultPages > 1 ? ' Showing first 100 results.' : ''));
                                grid.data('handsontable').loadData(data_data.results);
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                            else {
                                grid_console.text(textStatus+': Search error: '+jqXHRequest.statusText+', code: '+jqXHRequest.status+'.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + " ... " + textStatus);
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    });
                    currentPage = 1;
                };

                grid.parent().find('button[name=next]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (currentPage != resultPages) {
                        $.ajax({
                            url: data_data.next,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_data = response;
                                grid.data('handsontable').loadData(data_data.results);
                                currentPage++;
                                grid_console.text('Page ' + currentPage + ' of ' + resultPages + ' loaded.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            },
                            error: function (response) {
                                grid_console.text("error");
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    else {
                        grid_console.text("End of results, there are no pages after Page " + resultPages + ".");
                        loading_overlay.hide();
                        button_state.button('reset');
                    }
                    clearChangedRowIndices();
                });

                grid.parent().find('button[name=prev]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    if (currentPage != 1) {
                        $.ajax({
                            url: data_data.previous,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_data = response;
                                grid.data('handsontable').loadData(data_data.results);
                                currentPage--;
                                grid_console.text('Page ' + currentPage + ' of ' + resultPages + ' loaded.');
                                loading_overlay.hide();
                                button_state.button('reset');
                            },
                            error: function (response) {
                                grid_console.text("error");
                                loading_overlay.hide();
                                button_state.button('reset');
                            }
                        });
                    }
                    else {
                        grid_console.text("There are no pages before Page 1.");
                        loading_overlay.hide();
                        button_state.button('reset');
                    }
                    clearChangedRowIndices();
                });

                $('#lookupContainers').change(function () {
                    var settings = grid.handsontable('getInstance').getSettings();
                    if (this.checked) {
                        settings.columns[13] = {title: 'Container ID', data: 'sample_bottle.bottle.bottle_unique_name', width: 110, type: 'autocomplete', strict: true, source: function (query, process) {
                            getValuesAjax('/merlinservices/bottles/', 'bottle_unique_name', query, process)}};
                        grid.handsontable('getInstance').updateSettings(settings);
                    }
                    else {
                        settings.columns[13] = {title: 'Container ID', data: 'sample_bottle.bottle.bottle_unique_name', width: 110, type: 'text'};
                        grid.handsontable('getInstance').updateSettings(settings);
                    }
                });

                grid.parent().find('button[name=insert]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var settings = grid.handsontable('getInstance').getSettings();
                    function tempRenderer(instance, td) {
                        Handsontable.renderers.TextRenderer.apply(this, arguments);
                        td.style.backgroundColor = '#FFFFFF';
                        return td;
                    }
                    var sourceRowIndex = selectionRowIndices[0];
                    if (typeof sourceRowIndex == 'undefined') {grid_console.text('There is no selected row to clone!'); loading_overlay.hide(); button_state.button('reset'); return false;}
                    grid.data('handsontable').alter('insert_row', (sourceRowIndex + 1));
                    // get all the data for the source row
                    var sourceDataRow = grid.data('handsontable').getDataAtRow(sourceRowIndex);
                    // set the data in the target row for all sample header columns (1 through 12) and empty for the rest
                    for (var i = 0; i < sourceDataRow.length; i++) {
                        if (i < 13) {
                            grid.data('handsontable').setDataAtCell((sourceRowIndex + 1), i, sourceDataRow[i]);
                        }
                        else if (i == 15) {
                            settings.columns[i] = {title: 'Analysis', data: 'analysis_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 80, type: 'autocomplete', strict: true, source: function (query, process) {
                                getValuesAjax('/merlinservices/analyses/', 'analysis', query, process)}};
                            grid.handsontable('getInstance').updateSettings(settings);
                        }
                        else if (i == 16) {
                            settings.columns[i] = {title: 'Constituents', data: 'constituent_string', {% if not request.session.is_staff %} readOnly: true, {% endif %} width: 80, type: 'autocomplete', strict: true, source: function (query, process) {
                                getValuesAjax('/merlinservices/constituents/', 'constituent', query, process)}};
                            grid.handsontable('getInstance').updateSettings(settings);
                        }
                        else if (i == 17) {
                            grid.data('handsontable').setDataAtCell((sourceRowIndex + 1), i, "NA");
                        }
                        else {
                            grid.data('handsontable').setDataAtCell((sourceRowIndex + 1), i, null);
                            settings.columns[i]['renderer'] = tempRenderer;
                            grid.handsontable('getInstance').updateSettings(settings);
                            delete settings.columns[i]['renderer'];
                            grid.handsontable('getInstance').updateSettings(settings);
                        }
                    }
                    grid.handsontable('getInstance').deselectCell();
                    grid_console.text('Inserted Row.');
                    button_state.button('reset');
                    loading_overlay.hide();
                });

                grid.parent().find('button[name=remove]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var selectedRow = selectionRowIndices[0];
                    // check if a row has been selected for removal
                    if (typeof selectedRow == 'undefined') {grid_console.text('There are no selected rows to remove!');  loading_overlay.hide(); button_state.button('reset'); return false;}
                    // check if row is a clone
                    if (grid.data('handsontable').getDataAtCell(selectedRow, 25)) {grid_console.text('The selected row is not a clone and cannot be removed!');  loading_overlay.hide(); button_state.button('reset'); return false;}
                    else {grid.data('handsontable').alter('remove_row', selectedRow, 1);}
                    // clear list of selected rows
                    selectionRowIndices.length = 0;
                    grid_console.text('Removed Row.');
                    button_state.button('reset');
                    loading_overlay.hide();
                });

                // when the save button is clicked, loop through the list of changed rows and build a JSON object containing the changed rows
                //grid.parent().find('button[name=save]').click(function () {
                //    grid_console.text('Saving is disabled at the moment.');
                //});
                grid.parent().find('button[name=save]').click(function () {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    // an array container for storing the changed data rows to send to the database
                    var changedDataArray = [];
                    if (changedRowIndices.length == 0) {grid_console.text('There is nothing to save!'); loading_overlay.hide(); button_state.button('reset'); return;}
                    // loop through the list of changed rows
                    $.each(changedRowIndices, function(index, value) {
                        // grab all the data for this row
                        var thisChangedRowIndex = value;
                        var thisDataRow = grid.data('handsontable').getDataAtRow(thisChangedRowIndex);
                        // check if this row still has data; it's possible the user cleared the row after entering data, in which case we no longer want it
                        if (thisDataRow[0] !== null && thisDataRow[0] !== ""){
                            // an object container for the data in this row
                            var thisDataObject = {};
                            var gooddate_received;
                            var thisID;
                            // convert each cell in this row into an object property
                            for (var i = 0; i < thisDataRow.length; i++) {
                                switch(i){
                                    case 1: // project name
                                        // do nothing with this column
                                        //// if it has a value, look up and return the ID, otherwise notify the user that this is a required field, and stop the submission
                                        //if (!thisDataRow[i]) {grid_console.text('Project Name is required in row ' + (index + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        //else {
                                        //    thisID = updateValueAjax('/merlinservices/projects/', 'name', 'id', thisDataRow[i]);
                                        //    if (thisID == "" || typeof thisID === 'undefined') {grid_console.text('Project Name must be a valid choice in row ' + (index + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        //    thisDataObject[objectFields[i]] = thisID;
                                        //}
                                        break;
                                    case 2: // project ID
                                        // grab the project ID and ignore the project Name, since the ID would have automatically been updated to match the Name by the event settings in this grid's init settings.
                                        if (!thisDataRow[i]) {grid_console.text('Project ID is required in row ' + (thisChangedRowIndex + 1) + '! It might be missing if the associated Project Name cannot be found.'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        else {
                                            thisID = thisDataRow[i];
                                            if (thisID == "" || typeof thisID === 'undefined') {grid_console.text('Project ID must be a valid choice in row ' + (thisChangedRowIndex + 1) + '! It might be invalid if the associated Project Name cannot be found.'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 3: // site name
                                        // if it has a value, look up and return the ID, otherwise notify the user that this is a required field, and stop the submission
                                        if (!thisDataRow[i]) {grid_console.text('Site Name is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        else {
                                            thisID = updateValueAjax('/merlinservices/sites/', 'name_exact', 'id', thisDataRow[i], ('project=' + grid.handsontable('getInstance').getDataAtCell(thisChangedRowIndex, 2)));
                                            if (thisID == "" || typeof thisID === 'undefined') {grid_console.text('Site Name must be a valid choice in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 4: // site ID
                                        //// if it doesn't have a value, notify the user that this is a required field, and stop the submission
                                        //if (!thisDataRow[i]) {grid_console.text('Site ID is required!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        //else {thisDataObject[objectFields[i]] = getIdDom(data_sites,'usgs_scode',thisDataRow[i]);}

                                        // do nothing with this column
                                        break;
                                    case 5: // date
                                        // if it doesn't have a value, notify the user that this is a required field, and stop the submission
                                        if (!thisDataRow[i]) {grid_console.text('Sample Date is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        // if it has a value but with bad formatting, notify the user, and stop the submission
                                        if (!(dateRegEx.test(thisDataRow[i]))) {grid_console.text('Sample Date is badly formed in row ' + (thisChangedRowIndex + 1) + '. Expecting a date in mm/dd/yy format but found ' + thisDataRow[i] + '!'); validTable = false; button_state.button('reset'); return false;}
                                        break;
                                    case 6: // time
                                        // if it doesn't have a value, notify the user that this is a required field, and stop the submission
                                        if (!thisDataRow[i]) {grid_console.text('Time is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        if (thisDataRow[i] !== null && thisDataRow[i] !== "" && thisDataRow[i-1] !== null && thisDataRow[i-1] !== "") {
                                            var changedVal = thisDataRow[i].toString();
                                            var newValue;
                                            switch (changedVal.length) {
                                                case 1:
                                                    newValue = "00:0" + changedVal;
                                                    break;
                                                case 2:
                                                    newValue = "00:" + changedVal;
                                                    break;
                                                case 3:
                                                    newValue = "0" + changedVal.substring(0, 1) + ":" + changedVal.substring(1);
                                                    break;
                                                case 4:
                                                    newValue = changedVal.substring(0, 2) + ":" + changedVal.substring(2);
                                                    break;
                                                default:
                                                    // user must have entered an invalid time, so set it to midnight
                                                    newValue = "00:00";
                                                    break;
                                            }
                                            var dateReceived = thisDataRow[11];
                                            if (dateRegEx.test(dateReceived)) {
                                                if (makeYear(dateReceived)!= null && makeMonth(dateReceived)!= null && makeDay(dateReceived) != null) {
                                                    gooddate_received = new Date(makeYear(dateReceived), makeMonth(dateReceived)-1, makeDay(dateReceived));
                                                    if (gooddate_received > dateToday) {
                                                        {grid_console.text('Date Received cannot be a future date!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                                    }
                                                }
                                                else {grid_console.text('There is a problem with Received Date. Please contact the administrator.'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            }
                                            else {grid_console.text('Date Received is badly formed in row ' + (thisChangedRowIndex + 1) + '. Expecting a date in mm/dd/yy format but found ' + dateReceived + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            var baddate_sample = thisDataRow[i - 1];
                                            if (makeYear(baddate_sample)!= null && makeMonth(baddate_sample)!= null && makeDay(baddate_sample) != null) {
                                                var gooddate_sample_string = makeYear(baddate_sample) + "-" + makeMonth(baddate_sample) + "-" + makeDay(baddate_sample);
                                                var gooddate_sample = new Date(makeYear(baddate_sample), makeMonth(baddate_sample)-1, makeDay(baddate_sample));
                                                if (gooddate_sample > dateToday) {
                                                    {grid_console.text('Sample Date cannot be a future date!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                                }
                                                if (gooddate_sample > gooddate_received) {
                                                    {grid_console.text('Sample Date cannot be after Date Received!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                                }
                                                var dateTodayLastYear = new Date();
                                                //dateTodayLastYear.setTime(dateTodayLastYear.valueOf() - (365 * 24 * 60 * 60 * 1000));
                                                dateTodayLastYear.setFullYear(dateTodayLastYear.getFullYear() - 1);
                                                if (dateTodayLastYear > gooddate_sample) {
                                                    grid_console.text('Sample Date is more than one year before today in row ' + (thisChangedRowIndex + 1) + '!');
                                                    var confirmOldDate = confirm("WARNING: Sample Date is more than one year before today in row " + (thisChangedRowIndex + 1) + "!\nContinue and Save with the date entered, or Cancel?");
                                                    if (confirmOldDate == false) {validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                                }
                                                thisDataObject[objectFields[i]] = gooddate_sample_string + " " + newValue + ":00";
                                            }
                                            else {grid_console.text('There is a problem with Sample Date in row ' + (thisChangedRowIndex + 1) + '. Please contact the administrator.'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            //var gooddate_sample = "20" + baddate_sample.substr(6,4) + "-" + baddate_sample.substr(0,2) + "-" + baddate_sample.substr(3,2);
                                            //thisDataObject[objectFields[i]] = gooddate_sample + " " + newValue + ":00";
                                            //thisDataObject[objectFields[i]] = thisDataRow[i-1]+" "+newValue+":00";
                                        }
                                        break;
                                    case 7: // depth
                                        if (thisDataRow[i] !== 0) {
                                            if (!thisDataRow[i]) {grid_console.text('Depth is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        }
                                        thisDataObject[objectFields[i]] = (thisDataRow[i] % 1 === 0 ? (thisDataRow[i].toFixed(1)) : thisDataRow[i]);
                                        break;
                                    case 9: // rep
                                        if (thisDataRow[i] !== 1) {
                                            if (!thisDataRow[i]) {grid_console.text('Rep is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        }
                                        thisDataObject[objectFields[i]] = thisDataRow[i];
                                        break;
                                    case 10: // sample comments
                                        if (thisDataRow[i] == null) {
                                            thisDataRow[i] = "";
                                        }
                                        thisDataObject[objectFields[i]] = thisDataRow[i];
                                        break;
                                    case 11: // received date
                                        // validation is being handled in previous case (sample datetime)
                                        if (!thisDataRow[i]) {grid_console.text('Date Received is required!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        thisDataObject[objectFields[i]] = makeYear(dateReceived) + "-" + makeMonth(dateReceived) + "-" + makeDay(dateReceived);
                                        break;
                                    case 12: // processing
                                        // if it has a value, look up and return the ID, otherwise skip this field (won't be included in submission to database)
                                        if (thisDataRow[i] !== null && thisDataRow[i] !== "" && thisDataRow[i] !== 0 && typeof thisDataRow[i] !== 'undefined') {
                                            thisID = getIdDom(data_processings,'processing',thisDataRow[i]);
                                            if (thisID === null) {grid_console.text('Lab Processing must be a valid choice, or empty, in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 13: // bottle (container)
                                        // if it has a value, look up and return the ID, otherwise notify the user that this is a required field, and stop the submission
                                        if (!thisDataRow[i]) {grid_console.text('Container ID is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        else {
                                            thisID = updateValueAjax('/merlinservices/bottles/', 'bottle_unique_name', 'id', thisDataRow[i]);
                                            if (thisID == "" || typeof thisID === 'undefined') {grid_console.text('Container ID must be a valid choice in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 14: // medium
                                        // if it has a value, look up and return the ID, otherwise notify the user that this is a required field, and stop the submission
                                        if (!thisDataRow[i]) {grid_console.text('Medium is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        else {
                                            thisID = getIdDom(data_mediums,'display_text',thisDataRow[i]);
                                            if (thisID === null) {grid_console.text('Medium must be a valid choice in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 15: // analysis
                                        // if it has a value, look up and return the ID, otherwise notify the user that this is a required field, and stop the submission
                                        if (!thisDataRow[i]) {grid_console.text('Analysis is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        else {
                                            thisID = getIdDom(data_analyses,'analysis',thisDataRow[i]);
                                            if (thisID === null) {grid_console.text('Analysis must be a valid choice in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 16: // constituent
                                        // if it has a value, look up and return the ID, otherwise notify the user that this is a required field, and stop the submission
                                        if (!thisDataRow[i]) {grid_console.text('Constituent is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        else {
                                            thisID = getIdDom(data_constituents,'constituent',thisDataRow[i]);
                                            if (thisID === null) {grid_console.text('Constituent must be a valid choice in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 17: // isotope flag
                                        // if it has a value, look up and return the ID, otherwise notify the user that this is a required field, and stop the submission
                                        if (!thisDataRow[i]) {grid_console.text('Isotope is required in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                        else {
                                            thisID = getIdDom(data_isotopeflags,'isotope_flag',thisDataRow[i]);
                                            if (thisID === null) {grid_console.text('Isotope must be a valid choice in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 18: // filter
                                        // if it has a value, look up and return the ID, otherwise skip this field (won't be included in submission to database)
                                        if (thisDataRow[i] !== null && thisDataRow[i] !== "" && thisDataRow[i] !== 0 && typeof thisDataRow[i] !== 'undefined') {
                                            thisID = getIdDom(data_filters,'filter',thisDataRow[i]);
                                            if (thisID === null) {grid_console.text('Filter must be a valid choice, or empty, in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 20: // preservation
                                        // if it has a value, look up and return the ID, otherwise skip this field (won't be included in submission to database)
                                        if (thisDataRow[i] !== null && thisDataRow[i] !== "" && thisDataRow[i] !== 0 && typeof thisDataRow[i] !== 'undefined') {
                                            thisID = getIdDom(data_preservations,'preservation',thisDataRow[i]);
                                            if (thisID === null) {grid_console.text('Preservation must be a valid choice, or empty, in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 21: // acid
                                        // if it has a value, look up and return the ID, otherwise skip this field (won't be included in submission to database)
                                        if (thisDataRow[i] !== null && thisDataRow[i] !== "" && thisDataRow[i] !== 0 && typeof thisDataRow[i] !== 'undefined') {
                                            thisID = updateValueAjax('/merlinservices/acids/', 'code_exact', 'id', thisDataRow[i]);
                                            if (thisID == "" || typeof thisID === 'undefined') {grid_console.text('Acid must be a valid choice, or empty, in row ' + (thisChangedRowIndex + 1) + '!'); validTable = false; loading_overlay.hide(); button_state.button('reset'); return false;}
                                            thisDataObject[objectFields[i]] = thisID;
                                        }
                                        break;
                                    case 23: // preservation comments
                                        if (thisDataRow[i] == null) {
                                            thisDataRow[i] = "";
                                        }
                                        thisDataObject[objectFields[i]] = thisDataRow[i];
                                        break;
                                    case 24: // sample bottle ID
                                        thisDataObject[objectFields[i]] = thisDataRow[i];
                                        break;
                                    case 25: // result ID
                                        thisDataObject[objectFields[i]] = thisDataRow[i];
                                        break;
                                    default: // all the rest
                                        if (thisDataRow[i] !== null && thisDataRow[i] !== "") {
                                            thisDataObject[objectFields[i]] = thisDataRow[i];
                                        }
                                        break;
                                }
                            }
                            // add the new row object to the array
                            changedDataArray.push(thisDataObject);
                        }
                        // if we made it through the various validations above, then the table must be valid
                        validTable = true;
                    });
                    // if table is valid, submit the POST request, otherwise skip it (implying table is invalid)
                    if(validTable) {
                        // convert the array to a true JSON object
                        var changedDataJSON = JSON.stringify(changedDataArray);
                        // send the entire changed data object to the server via ajax
                        //console.log(changedDataJSON);
                        grid_console.text('Attempting to save data...');
                        // confirm that the user really does want to save
                        var confirmed = confirm("WARNING: This will overwrite existing records in the database!\nContinue and Save, or Cancel?");
                        if (confirmed == true) {
                            $.ajax({
                                url: "{% url 'merlin:samples_update' %}",
                                data: changedDataJSON,
                                dataType: 'json',
                                contentType: "application/json",
                                type: 'POST',
                                success: function (data, textStatus, jqXHRequest) {
                                    var content_type = jqXHRequest.getResponseHeader("content-type");
                                    // if the content-type is plain text, then it's a custom message from our Django view
                                    if (content_type.indexOf('text') > -1) {
                                        grid_console.text(data);
                                        loading_overlay.hide();
                                        button_state.button('reset');
                                    }
                                    // otherwise, it's JSON from the REST Services
                                    else if (jqXHRequest.status === 200) {
                                        grid_console.text(textStatus + ': Data saved.');
                                        loading_overlay.hide();
                                        button_state.button('reset');
                                    }
                                    else {
                                        grid_console.text(textStatus + ': Save error: ' + jqXHRequest.statusText + ', code: ' + jqXHRequest.status + '.');
                                        loading_overlay.hide();
                                        button_state.button('reset');
                                    }
                                },
                                error: function (jqXHRequest, textStatus, errorThrown) {
                                    grid_console.text(errorThrown + ": " + textStatus);
                                    loading_overlay.hide();
                                    button_state.button('reset');
                                }
                            });
                        }
                        else {
                            loading_overlay.hide();
                            button_state.button('reset');
                        }
                    clearChangedRowIndices();
                    }
                });

                grid.parent().find('button[name=exportCSV]').click(function() {
                    if (exportCSVClicked) {
                        exportCSVClicked = false;
                        $("#exportCSVButtonPanel").hide();
                    }
                    else {
                        exportCSVClicked = true;
                        $("#exportCSVButtonPanel").show();
                    }
                });

                grid.parent().find('button[name=exportCSVCurrentPage]').click(function() {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    var table = grid.handsontable('getInstance');
                    var csv_filename = "samples_" + yearToday + "-" + (monthToday.length == 1 ? "0" + monthToday : monthToday) + "-" + (dayToday.length == 1 ? "0" + dayToday : dayToday) + ".csv";
                    handsontable2csv.download(table, csv_filename);
                    grid.parent().find('button[name=exportCSV]').click();
                    loading_overlay.hide();
                    button_state.button('reset');
                });

                grid.parent().find('button[name=exportCSVAllPages]').click(function() {
                    var button_state = $(this).button('loading');
                    loading_overlay.show();
                    // if there is only one result page, then there is no need to request more data from the server, so just export the current page
                    if (resultPages == 1) {grid.parent().find('button[name=exportCSVCurrentPage]').click(); loading_overlay.hide(); button_state.button('reset'); return false;}
                    // else if there is less than two result pages and not one result page (i.e., zero), stop the export
                    else if (resultPages < 2) {return false;}
                    // otherwise request all the data matching the search query from the server
                    var thisDataObject = {};
                    if (penultimateSearchWasMultiBottle) {
                        thisDataObject['bottle'] = bottleIds.join(",");
                        thisDataObject['analysis'] = $("#select_analysis_bottle_modal").val();
                    }
                    else if ($(select_bottle).val() != "") {
                        thisDataObject['bottle'] = $(select_bottle).val();
                        thisDataObject['analysis'] = $("#select_analysis_bottle").val();
                    }
                    else if ($(select_analysis).val() != "") {thisDataObject['analysis'] = $(select_analysis).val()}
                    if ($(select_project).val() != "") {thisDataObject['project'] = $(select_project).val()}
                    if ($(select_site).val() != "") {thisDataObject['site'] = $(select_site).val()}
                    if ($("#select_depth").val() != "") {thisDataObject['depth'] = $("#select_depth").val()}
                    if ($("#select_replicate").val() != "") {thisDataObject['replicate'] = $("#select_replicate").val()}
                    var formattedDate = "";
                    if (date_after_sample.toString('MM/DD/YY') != "") {formattedDate = formatDate(date_after_sample.toString('MM/DD/YY')); if (isNaN(formattedDate.slice(0,4)) && formattedDate != "") {grid_console.text(formattedDate); loading_overlay.hide(); button_state.button('reset'); return false;} else {thisDataObject['date_after_sample'] = formattedDate;}} else {formattedDate = ""}
                    if (date_before_sample.toString('MM/DD/YY') != "") {formattedDate = formatDate(date_before_sample.toString('MM/DD/YY')); if (isNaN(formattedDate.slice(0,4)) && formattedDate != "") {grid_console.text(formattedDate); loading_overlay.hide(); button_state.button('reset'); return false;} else {thisDataObject['date_before_sample'] = formattedDate;}} else {formattedDate = ""}
                    thisDataObject['format'] = "csv";
                    thisDataObject['table'] = "sample";
                    // page_size is the parameter that will override our self-defined default 100-record pagination
                    // setting it to the nearest hundred above the record count will ensure we get all matching records
                    thisDataObject['page_size'] = (resultPages * 100);
                    var dataJSON = JSON.stringify(thisDataObject);
                    var link = document.createElement("a");
                    link.setAttribute("href", "/merlinservices/fullresults/?"+ $.param(thisDataObject));
                    link.setAttribute("download", "");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    // some testing indicated that the server takes 0.33 seconds for each page requested
                    setTimeout(function(){grid.parent().find('button[name=exportCSV]').click();}, (resultPages * 330));
                    setTimeout(function(){loading_overlay.hide();}, (resultPages * 330));
                    setTimeout(function(){button_state.button('reset');}, (resultPages * 330));
                });

                $("#multi_bottle_search").click(function(){
                    $("#multi_bottle_search").button('loading');
                    $('#s2id_select_bottle .select2-search-choice').remove();
                    var textValue = $("#bottle_search_list").val();
                    // split the values with a newline, tab, or comma
                    var bottle_list = textValue.split(/[\n\t,]+/);
                    bottleIds.length = 0;
                    //check for empty strings
                    for(var i = 0; i < bottle_list.length; i++){
                        if(bottle_list[i].trim()){
                            bottleIds.push(bottle_list[i].trim());
                        }
                    }
                    var analysisId = $("#select_analysis_bottle_modal").val();
                    //get bottles
                    $('#multiBottleSearchModal').modal('hide');
                    if(bottleIds.length > 0){
                        // also clear the main form search so it doesn't interfere with multi-bottle modal search
                        $("#select_bottle").val("");
                        $("#select_analysis_bottle").select2('val', '');
                        searchBottles('#multi_bottle_search',bottleIds.join(","),analysisId);
                    }
                });

            });
        </script>

    </div>

{% endblock %}
